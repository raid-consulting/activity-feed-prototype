<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI Review</title>
<style>
  :root {
    --radius:14px;
    --gap:12px;
    --focus:#6ea4e8;
    --page-pad:clamp(16px,3vw,28px);
    --frame-gap:clamp(12px,2.2vw,18px);
    --footer-safe-area:env(safe-area-inset-bottom);
    --card-stripe:clamp(6px,1vw,10px);
  }
  :root, html[data-theme="dark"] {
    --bg:#141b26; --panel:#1a2330; --ink:#f4f7fb; --text:#d7dee7; --muted:#a5b3c5;
    --line:#364353; --card:#1d2735; --card-hover:#243041; --banner:#1b2534;
    --detail:#202b3b; --btn:#232f3f; --btn-hover:#2a3749; --accent-muted:#93a5bb;
    --red:#ea7c76; --green:#5ec49d; --blue:#78aeea; --amber:#e7ad6a; --crimson:#ed8a7d;
    --grey:#8a97ab; --shadow:0 6px 24px rgba(6,11,20,.32);
  }
  html[data-theme="light"] {
    --bg:#f2f4f7; --panel:#ffffff; --ink:#1e2936; --text:#2e3a4c; --muted:#647184;
    --line:#d0d7e2; --card:#ffffff; --card-hover:#f5f7fa; --banner:#f1f3f7;
    --detail:#f7f9fc; --btn:#eceff5; --btn-hover:#e1e5ed; --accent-muted:#7b889b;
    --red:#c6615b; --green:#3c8f6b; --blue:#3a7bd5; --amber:#c38b44; --crimson:#c46f63;
    --grey:#6b778a; --shadow:0 4px 18px rgba(15,23,42,.08); --focus:#3a7bd5;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);
    font: clamp(15px,1.6vw,17px)/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    min-height:100vh;display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;
    gap:var(--page-pad);padding:var(--page-pad);
    overflow-x:hidden;transition:background .2s,color .2s}
  .frame{margin:0 auto;width:min(1100px,100%);max-width:100%;background:var(--panel);border:2px solid var(--line);
    border-radius:18px;padding:clamp(12px,2.2vw,18px);box-shadow:var(--shadow);
    display:grid;gap:var(--frame-gap);flex:1 0 auto;min-height:0}
  .frame > *{margin-block:0}
  .frame > :first-child{margin-block-start:0}
  .frame > :first-child + *{margin-block-start:0}
  #globalMenu{display:contents}
  .inner{display:grid;gap:clamp(14px,2vw,18px);background:var(--panel);
    border:2px solid var(--line);border-radius:14px;padding:clamp(14px,2vw,20px)}

  .global-menu{display:flex;align-items:center;justify-content:space-between;
    padding:clamp(10px,1.8vw,14px) clamp(12px,2.2vw,16px);background:var(--banner);
    border:2px solid var(--line);border-radius:12px;flex-wrap:wrap;gap:12px}
  .global-title{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px;
    font-size:clamp(18px,2.2vw,21px);color:var(--ink)}
  .global-nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;margin-left:auto}
  .link{color:var(--ink);text-decoration:none;font-weight:700;padding:8px 12px;border-radius:10px;border:2px solid var(--line);
    background:var(--btn);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;min-height:40px}
  .link:hover{background:var(--btn-hover)}
  .link[aria-current="page"]{background:var(--ink);color:var(--bg);border-color:var(--ink)}
  .toggle{width:54px;height:30px;border-radius:100px;border:2px solid var(--line);background:var(--btn);position:relative;cursor:pointer}
  .toggle:hover{background:var(--btn-hover)}
  .toggle:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
  .knob{width:22px;height:22px;border-radius:50%;background:var(--ink);position:absolute;top:50%;transform:translateY(-50%);left:4px;transition:left .2s}
  html[data-theme="light"] .knob{left:28px}
  .app-footer{position:sticky;bottom:0;background:var(--banner);border-top:2px solid var(--line);
    padding:clamp(12px,2vw,18px) clamp(18px,3vw,28px);
    padding-bottom:calc(clamp(12px,2vw,18px) + var(--footer-safe-area));display:flex;flex-wrap:wrap;gap:12px;align-items:center;
    justify-content:space-between;z-index:100;box-shadow:0 -6px 18px rgba(6,11,20,.24);margin-inline:calc(-1 * var(--page-pad))}
  .footer-meta{display:flex;flex-direction:column;gap:2px;color:var(--muted)}
  .footer-meta strong{color:var(--ink);font-size:clamp(14px,1.7vw,16px)}
  .footer-actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .footer-button{appearance:none;border:2px solid var(--line);background:var(--btn);color:var(--ink);
    padding:8px 14px;border-radius:10px;font-weight:700;cursor:pointer;min-height:40px;display:inline-flex;align-items:center;justify-content:center}
  .footer-button:hover{background:var(--btn-hover)}
  .footer-button[disabled]{opacity:.6;cursor:not-allowed}
  .footer-theme{display:flex;align-items:center;gap:10px}
  .footer-theme-label{color:var(--muted);font-weight:600}

  .section-banner{display:flex;align-items:center;justify-content:space-between;gap:14px;
    padding:clamp(12px,2vw,16px);background:var(--banner);border:2px solid var(--line);border-radius:12px}
  .section-title{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px;
    font-size:clamp(18px,2.4vw,22px);color:var(--ink);margin:0}
  .section-subtitle{margin:0;color:var(--muted);font-size:clamp(13px,1.6vw,15px)}

  .controls{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between;align-items:center}
  .filters{display:flex;flex-wrap:wrap;gap:8px}
  .pill{appearance:none;border:2px solid var(--line);background:var(--btn);color:var(--text);
    padding:8px 12px;border-radius:999px;font-weight:700;display:inline-flex;align-items:center;gap:8px;cursor:pointer;min-height:38px}
  .pill:hover{background:var(--btn-hover)}
  .pill[aria-pressed="true"]{background:var(--ink);color:var(--bg);border-color:var(--ink)}
  .pill-count{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;border-radius:999px;
    background:rgba(0,0,0,.25);color:var(--ink);font-size:12px;font-weight:700;padding:0 6px}
  .pill[aria-pressed="true"] .pill-count{background:rgba(0,0,0,.3);color:var(--bg)}
  .pill-green[aria-pressed="true"]{background:var(--green);border-color:var(--green);color:#0d1b12}
  .pill-red[aria-pressed="true"]{background:var(--red);border-color:var(--red);color:#2c0908}
  .pill-blue[aria-pressed="true"]{background:var(--blue);border-color:var(--blue);color:#081d2c}
  .pill-grey[aria-pressed="true"]{background:var(--grey);border-color:var(--grey);color:#07090d}
  .pill label{font-weight:inherit}
  .search{position:relative;display:inline-flex;align-items:center}
  .search input{width:min(260px,70vw);padding:10px 12px;border:2px solid var(--line);border-radius:10px;background:var(--card);color:var(--text);font:inherit}
  .search input::placeholder{color:var(--muted)}

  .sr-only{position:absolute;clip:rect(1px,1px,1px,1px);clip-path:inset(0 0 99.9% 99.9%);height:1px;width:1px;overflow:hidden;padding:0;border:0}

  .stack{display:grid;gap:16px}
  .group{display:grid;gap:12px}
  .group-header{display:grid;gap:6px}
  .group-title{font-weight:800;color:var(--ink);font-size:clamp(16px,2vw,19px);display:flex;gap:10px;align-items:center}
  .group-description{margin:0;color:var(--muted);font-size:clamp(13px,1.6vw,15px)}
  .group-count{font-size:13px;color:var(--muted);font-weight:600}
  .group-cards{display:grid;gap:12px}

  .card{display:grid;grid-template-columns:var(--card-stripe) 1fr auto;gap:0;align-items:start;
    padding:0;background:var(--card);border-radius:var(--radius);border:2px solid var(--line);
    cursor:pointer;transition:background .15s,transform .05s,border-color .2s;text-align:left;overflow:hidden}
  .card:hover{background:var(--card-hover);transform:translateY(-1px)}
  .card:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
  .card-stripe{width:var(--card-stripe);min-width:var(--card-stripe);background:var(--grey);align-self:stretch}
  .card-stripe-green{background:var(--green)}
  .card-stripe-red{background:var(--red)}
  .card-stripe-blue{background:var(--blue)}
  .card-stripe-grey{background:var(--grey)}
  .card-content{display:grid;gap:6px;align-content:start;align-items:start;justify-content:start;justify-items:start;
    padding:clamp(12px,1.9vw,16px) clamp(12px,1.9vw,16px)}
  .card-header{display:flex;align-items:flex-start;justify-content:flex-end}
  .title-text{color:var(--ink);font-weight:800;letter-spacing:.2px;font-size:clamp(15px,1.9vw,17px);margin:0}
  .description{color:var(--text);opacity:.9;font-size:clamp(14px,1.8vw,16px);margin:0}
  .meta{color:var(--muted);font-size:clamp(13px,1.6vw,15px)}
  .chev{opacity:.9;align-self:center;padding:0 clamp(12px,2vw,16px);display:flex;align-items:center;justify-content:center}
  .badge{display:inline-flex;align-items:center;gap:6px;font-size:clamp(12px,1.5vw,13px);font-weight:700;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.08);color:var(--ink);border:1px solid var(--line)}
  .timestamp{margin-left:auto;color:var(--muted);font-size:clamp(12px,1.5vw,13px)}

  .empty{padding:32px;border:2px dashed var(--line);border-radius:12px;text-align:center;color:var(--muted);background:var(--card);display:grid;gap:12px;justify-items:center}
  .empty[hidden]{display:none!important}
  .error{padding:32px;border:2px dashed var(--red);border-radius:12px;text-align:center;color:var(--ink);background:rgba(234,124,118,.1);display:grid;gap:12px;justify-items:center}
  .error[hidden]{display:none!important}
  .error p{margin:0;font-weight:700}
  .empty-refresh{appearance:none;border:2px solid var(--line);background:var(--btn);color:var(--ink);padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer}
  .empty-refresh:hover{background:var(--btn-hover)}
  .empty-refresh:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
  .loading{padding:32px;border:2px solid var(--line);border-radius:12px;text-align:center;font-weight:700;color:var(--ink);background:var(--card)}
  .inline-alert{display:flex;align-items:center;gap:12px;padding:14px 18px;border-radius:12px;background:rgba(231,173,106,.14);border:2px solid var(--amber);color:var(--ink);font-weight:600}
  .inline-alert[hidden]{display:none!important}
  .inline-alert[data-banner-kind="cached"]{display:none}
  .inline-alert[data-banner-kind="cached"][data-banner-visible="true"]{display:flex}
  .inline-alert__message{flex:1;min-width:0}
  .inline-alert__actions{display:flex;gap:10px}
  .inline-alert button{appearance:none;border:2px solid var(--line);background:var(--btn);color:var(--ink);padding:8px 14px;border-radius:999px;font-weight:700;cursor:pointer;min-height:38px}
  .inline-alert button:hover{background:var(--btn-hover)}
  .inline-empty{padding:24px;border:2px dashed var(--line);border-radius:12px;text-align:center;color:var(--muted);background:var(--card);font-weight:600}

  .detail-view{display:none;grid-template-columns:1fr;gap:16px}
  .detail-view[aria-hidden="false"]{display:grid}
  .detail{background:var(--detail);border:2px solid var(--line);border-radius:12px;padding:clamp(14px,2.2vw,20px)}
  .detail-head{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
  .crumbs{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:clamp(13px,1.6vw,15px)}
  .crumbs strong{color:var(--ink)}
  .crumbs button{background:none;border:none;color:var(--ink);font-weight:700;cursor:pointer;padding:0;font-size:inherit}
  .crumbs button:hover{text-decoration:underline}
  .detail .label{color:var(--muted);font-size:clamp(13px,1.5vw,15px);margin-bottom:6px}
  .detail h2{margin:0 0 8px 0;font-size:clamp(18px,2.2vw,22px);color:var(--ink)}
  .detail p{margin:0 0 12px 0}
  .detail .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{appearance:none;border:2px solid var(--line);background:var(--btn);color:var(--text);
    padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;min-height:44px}
  .btn:hover{background:var(--btn-hover)}
  .detail-tag{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;font-weight:700;font-size:clamp(12px,1.5vw,13px);background:var(--card);border:1px solid var(--line);color:var(--ink)}
  .detail-tag::before{content:'';width:10px;height:10px;border-radius:50%}
  .detail-tag.green::before{background:var(--green)}
  .detail-tag.red::before{background:var(--red)}
  .detail-tag.blue::before{background:var(--blue)}
  .detail-tag.grey::before{background:var(--grey)}

  @media (max-width:720px){
    .controls{flex-direction:column;align-items:stretch}
    .search{width:100%}
    .search input{width:100%}
  }
</style>
</head>
<body>
  <main class="frame">
    <div id="globalMenu"></div>
    <section class="inner">
      <header class="section-banner">
        <h1 class="section-title">AI review</h1>
        <p class="section-subtitle">Track automation readiness by color-coded signal.</p>
      </header>

      <div class="controls" aria-label="AI review filters">
        <div class="filters" role="toolbar" aria-label="Category filters">
          <button class="pill" type="button" data-filter="all" aria-pressed="true">All <span class="pill-count" data-count="all">0</span></button>
          <button class="pill pill-green" type="button" data-filter="green" aria-pressed="false">Green <span class="pill-count" data-count="green">0</span></button>
          <button class="pill pill-blue" type="button" data-filter="blue" aria-pressed="false">Blue <span class="pill-count" data-count="blue">0</span></button>
          <button class="pill pill-red" type="button" data-filter="red" aria-pressed="false">Red <span class="pill-count" data-count="red">0</span></button>
          <button class="pill pill-grey" type="button" data-filter="grey" aria-pressed="false">Grey <span class="pill-count" data-count="grey">0</span></button>
        </div>
        <label class="search">
          <span class="sr-only" id="searchLabel">Search keywords</span>
          <input id="searchInput" type="search" placeholder="Search subjects or senders" aria-labelledby="searchLabel">
        </label>
      </div>

      <div id="reviewContent">
        <div class="inline-alert" id="degradedBanner" data-banner-kind="cached" hidden role="status" aria-live="polite">
          <span class="inline-alert__message" id="degradedMessage">Showing cached results while we reconnect…</span>
          <div class="inline-alert__actions">
            <button type="button" id="degradedRetry">Retry</button>
          </div>
        </div>
        <div class="loading" id="loadingState" role="status">Loading review signals…</div>
        <div class="stack" id="groupContainer" hidden></div>
        <div class="inline-empty" id="noResultsNotice" hidden role="status" aria-live="polite">No review items match your filters.</div>
        <div class="empty" id="emptyState" data-empty-banner="true" hidden role="region" aria-label="AI review empty state" tabindex="-1">
          <p>No items to review yet.</p>
          <button class="empty-refresh" type="button" id="emptyRefresh">Refresh now</button>
        </div>
        <div class="error" id="errorState" data-banner-kind="error" hidden role="region" aria-label="AI review error state" tabindex="-1">
          <p>We hit a snag loading review signals.</p>
          <button class="empty-refresh" type="button" id="errorRetry">Try again</button>
        </div>
      </div>

      <div class="detail-view" id="detailView" aria-hidden="true">
        <div class="detail-head">
          <div class="crumbs">
            <button type="button" id="detailBack">AI review</button>
            <span>/</span>
            <strong id="detailCrumb">Details</strong>
          </div>
          <button class="btn" type="button" id="detailBackBtn">Back to list</button>
        </div>
        <article class="detail" aria-live="polite">
          <div class="label">Message</div>
          <span class="detail-tag" id="detailTag">Grey • Metadata pending</span>
          <h2 id="detailTitle">Select an item</h2>
          <p id="detailMeta">Pick a review item to see its automation readiness.</p>
          <p id="detailSynopsis"></p>
          <p class="meta" id="detailAiMeta"></p>
          <p class="meta" id="detailAiRequirements"></p>
          <p id="detailBody"></p>
          <div class="actions">
            <button class="btn" id="detailOpen">Open in inbox</button>
            <button class="btn" id="detailApprove">Approve automation</button>
            <button class="btn" id="detailArchive">Archive</button>
            <button class="btn" id="detailReassess">Reassess AI metadata</button>
          </div>
        </article>
      </div>
    </section>
  </main>

  <footer id="appFooter" class="app-footer" role="contentinfo"></footer>
<script src="footer-overscroll.js"></script>
<script src="refresh-utils.js"></script>
<script src="ai-classifier.js"></script>
<script src="ai-category-constants.js"></script>
<script>
  const DB_KEY='faux-emails', AUTH_KEY='faux-auth';
  const LOAD_TIMEOUT_MS=10000;
  const DEFAULT_ERROR_MESSAGE='We hit a snag loading review signals.';

  const telemetry=(window.telemetry && typeof window.telemetry.log==='function')
    ? window.telemetry
    : {
        log(event,payload){
          if(window && window.console && typeof window.console.log==='function'){
            window.console.log(`[telemetry] ${event}`, payload);
          }
        }
      };

  function svgPentagon(){ return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l9 6-3.4 10.5H6.4L3 8l9-6z"/></svg>'; }
  function escapeHtml(str=''){ const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}; return String(str).replace(/[&<>"']/g,ch=>map[ch]); }
  function setTheme(theme){
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('notif-theme', theme);
    syncThemeControls();
  }
  function syncThemeControls(){
    const currentTheme=document.documentElement.getAttribute('data-theme')||'dark';
    const label=document.getElementById('themeLabel');
    if(label){ label.textContent=currentTheme==='light'?'Light':'Dark'; }
    const toggle=document.getElementById('themeToggle');
    if(toggle){
      const isLight=currentTheme==='light';
      toggle.setAttribute('aria-pressed', isLight?'true':'false');
      toggle.setAttribute('aria-label', isLight?'Switch to dark theme':'Switch to light theme');
    }
  }
  (function initTheme(){
    const stored=localStorage.getItem('notif-theme');
    if(stored){ setTheme(stored); }
    else {
      const prefersLight=window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      setTheme(prefersLight?'light':'dark');
    }
  })();

  function seedDB(){
    if(localStorage.getItem(DB_KEY)) return;
    const now=Date.now();
    const emails=[
      {id:'e1', from:'billing@tenant.io', subject:'Payment overdue: INV-1043', body:'Please process the pending invoice within 3 days to avoid late fees. Manual review advised before charging the account.', status:'urgent', received: now-3600*1000*6},
      {id:'e2', from:'noreply@mailer.ai', subject:'Draft reply prepared', body:'AI drafted a response to tenant question about parking. Review and approve to send automatically.', status:'draft', received: now-3600*1000*12},
      {id:'e3', from:'support@locks.example', subject:'Smartlock offline – needs context', body:'Device reported intermittent connectivity and needs context about the environment before attempting a reset.', status:'needs_context', received: now-3600*1000*22},
      {id:'e4', from:'updates@crm.example', subject:'Profile note: tenant has a dog', body:'FYI: Add pet note to the profile. No action required yet.', status:'info', received: now-3600*1000*30},
      {id:'e5', from:'system@ops.example', subject:'Unhandled case detected', body:'AI could not determine a safe action. Manual review required to resolve the unhandled workflow.', status:'manual', received: now-3600*1000*40}
    ];
    const assessed = window.AIClassifier ? window.AIClassifier.ingest(emails, new Date(now)) : emails;
    localStorage.setItem(DB_KEY, JSON.stringify(assessed));
  }

  function rawEmails(){
    try{
      return JSON.parse(localStorage.getItem(DB_KEY))||[];
    }catch{
      return [];
    }
  }

  function persistEmails(emails){
    localStorage.setItem(DB_KEY, JSON.stringify(emails));
  }

  function getEmails(){
    const emails = rawEmails();
    let mutated = false;
    if(window.AIClassifier){
      emails.forEach(email => {
        const version = email.ai && email.ai.assessor_version;
        if(!email.ai){
          window.AIClassifier.applyAssessment(email);
          mutated = true;
        } else if(version === 'manual-override'){
          email.aiCategory = email.ai.category;
          email.aiSynopsis = email.ai.notes;
        } else if(version !== window.AIClassifier.VERSION){
          window.AIClassifier.applyAssessment(email);
          mutated = true;
        } else {
          email.aiCategory = email.ai.category;
          email.aiSynopsis = email.ai.notes;
        }
      });
    }
    if(mutated){
      persistEmails(emails);
    }
    return emails;
  }

  function reassessEmail(id){
    if(!window.AIClassifier) return null;
    const emails = rawEmails();
    const updated = window.AIClassifier.reassess(emails, id, new Date());
    if(updated){
      persistEmails(emails);
    }
    return updated;
  }

  window.aiAssessorAPI = {
    reassessEmail
  };

  seedDB();

  function isAuthed(){ return !!localStorage.getItem(AUTH_KEY); }
  function getCurrentUser(){ return localStorage.getItem(AUTH_KEY) || ''; }

  function globalMenuHtml({authed=false}={}){
    const currentPage=(window.location.pathname.split('/').pop()||'ai-review.html').toLowerCase();
    const navLinks=authed
      ? [
          {href:'index.html',label:'Activity'},
          {href:'ai-review.html',label:'AI review'},
          {href:'admin.html',label:'Admin'}
        ].map(({href,label})=>{
          const isCurrent=currentPage===href.toLowerCase();
          const aria=isCurrent?' aria-current="page"':'';
          return `<a class="link" href="${href}"${aria}>${label}</a>`;
        }).join('')
      : '';
    const nav=authed?`<nav class="global-nav" aria-label="Primary navigation">${navLinks}</nav>`:'';
    return `
      <div class="global-menu">
        <div class="global-title">${svgPentagon()} Operations Console</div>
        ${nav}
      </div>`;
  }

  function globalFooterHtml({authed=false,user=''}={}){
    const displayName=authed && user?escapeHtml(user):'—';
    const themeLabel=document.documentElement.getAttribute('data-theme')==='light'?'Light':'Dark';
    const logoutAttrs=authed?'':' disabled aria-disabled="true"';
    return `
      <div class="footer-meta" aria-live="polite">
        <span>Signed in as</span>
        <strong>${displayName}</strong>
      </div>
      <div class="footer-actions">
        <button class="footer-button" type="button" id="logoutBtn"${logoutAttrs}>Logout</button>
        <div class="footer-theme">
          <span class="footer-theme-label" id="themeLabel">${themeLabel}</span>
          <button class="toggle" type="button" id="themeToggle" aria-pressed="false">
            <span class="knob"></span>
          </button>
        </div>
      </div>`;
  }

  function renderFooter({authed=false,user='',onLogout}={}){
    const host=document.getElementById('appFooter');
    if(!host) return;
    host.innerHTML=globalFooterHtml({authed,user});
    attachGlobalFooterHandlers(onLogout);
  }

  function handleLogout(){
    localStorage.removeItem(AUTH_KEY);
    window.location.replace('index.html');
  }

  function attachGlobalFooterHandlers(onLogout){
    syncThemeControls();
    const toggle=document.getElementById('themeToggle');
    if(toggle){ toggle.addEventListener('click',()=>{
      const current=document.documentElement.getAttribute('data-theme')||'dark';
      setTheme(current==='dark'?'light':'dark');
    }); }
    const logout=document.getElementById('logoutBtn');
    if(logout && !logout.disabled){
      logout.addEventListener('click',()=>{
        if(typeof onLogout==='function'){
          onLogout();
        } else {
          handleLogout();
        }
      });
    }
  }

  const authed=isAuthed();
  const currentUser=authed?getCurrentUser():'';
  const globalMenuHost=document.getElementById('globalMenu');
  if(globalMenuHost){ globalMenuHost.innerHTML=globalMenuHtml({authed}); }
  renderFooter({authed,user:currentUser,onLogout:authed?handleLogout:undefined});
  if(!authed){
    window.location.replace('index.html');
  } else {

  const AICategory = window.AICategory || {
    AI_CATEGORY_COPY: {},
    normalizeCategory: () => 'grey',
    getCategoryPresentation: () => ({ key: 'grey', title: 'Unassessed', description: 'Awaiting AI review.', stripeClass: 'card-stripe-grey', ariaLabel: 'Unassessed' })
  };

  const CATEGORY_INFO={
    green:{detail:'Automation can proceed with high confidence.'},
    blue:{detail:'More context is required before automation can resume.'},
    red:{detail:'Risk detected — manual intervention recommended.'},
    grey:{detail:'AI has not provided metadata for this item yet.'}
  };

  function formatList(items, fallback='None'){
    return Array.isArray(items) && items.length ? items.join(', ') : fallback;
  }

  function formatConfidence(ai){
    return typeof ai.confidence === 'number' ? `${Math.round(ai.confidence * 100)}%` : null;
  }

  const VIEW_STATES={
    IDLE:'idle',
    LOADING:'loading',
    SUCCESS:'success',
    EMPTY:'empty',
    ERROR:'error',
    DEGRADED:'degraded'
  };

  const state={
    items:[],
    cachedItems:[],
    filter:'all',
    search:'',
    view:VIEW_STATES.IDLE,
    detailId:null,
    errorMessage:'',
    lastView:VIEW_STATES.IDLE,
    pendingLoad:false,
    ui:{
      banner:{
        kind:null
      }
    },
    loadOutcome:{
      phase:'idle',
      itemCount:0,
      usingCache:false,
      retries:0,
      maxRetries:0,
      durationMs:0,
      networkWasOffline:false,
      lastErrorCode:null,
      lastErrorMessage:'',
      timestamp:new Date().toISOString()
    }
  };

  function logInfoEvent(event,payload){
    try {
      if(window && window.console && typeof window.console.info==='function'){
        window.console.info('[ai_review]', event, payload);
      }
    } catch (_) {
      /* noop */
    }
  }

  let lastStatePhase='';
  let lastStatePayload='';
  let lastBannerLog='';
  let lastConflictLog='';

  function logStateSnapshot(){
    const payload={
      phase:state.loadOutcome.phase,
      view:state.view,
      itemCount:state.loadOutcome.itemCount,
      usingCache:state.loadOutcome.usingCache,
      retries:state.loadOutcome.retries,
      durationMs:state.loadOutcome.durationMs,
      networkWasOffline:state.loadOutcome.networkWasOffline,
      timestamp:state.loadOutcome.timestamp
    };
    const fingerprint=`${payload.phase}|${JSON.stringify(payload)}`;
    if(payload.phase===lastStatePhase && fingerprint===lastStatePayload) return;
    lastStatePhase=payload.phase;
    lastStatePayload=fingerprint;
    logInfoEvent('ai_review_state', payload);
  }

  function logBannerDecision(payload){
    const fingerprint=JSON.stringify(payload);
    if(fingerprint===lastBannerLog) return;
    lastBannerLog=fingerprint;
    logInfoEvent('banner_decision', payload);
  }

  function logBannerConflict(active){
    const payload={
      active,
      snapshot:{
        phase:state.loadOutcome.phase,
        itemCount:state.loadOutcome.itemCount,
        usingCache:state.loadOutcome.usingCache,
        retries:state.loadOutcome.retries,
        networkWasOffline:state.loadOutcome.networkWasOffline
      }
    };
    const fingerprint=JSON.stringify(payload);
    if(fingerprint===lastConflictLog) return;
    lastConflictLog=fingerprint;
    logInfoEvent('banner_conflict', payload);
  }

  function logCachedBanner(tag,payload){
    try {
      if(window && window.console && typeof window.console.info==='function'){
        window.console.info(`[ai_review.cached] ${tag}`, payload);
      }
    } catch (_) {
      /* noop */
    }
  }

  function logErrorBanner(tag,payload){
    try {
      if(window && window.console && typeof window.console.info==='function'){
        window.console.info(`[ai_review.error] ${tag}`, payload);
      }
    } catch (_) {
      /* noop */
    }
  }

  function normalizeErrorText(value){
    return String(value||'').replace(/\s+/g,' ').trim();
  }

  function nodeIsInShadowRoot(node){
    if(!node || typeof node.getRootNode!=='function') return false;
    try {
      const root=node.getRootNode();
      return typeof ShadowRoot!=='undefined' && root instanceof ShadowRoot;
    } catch (_) {
      return false;
    }
  }

  function computeNodePath(node){
    if(!node) return 'unknown';
    const segments=[];
    let current=node;
    while(current){
      if(current.nodeType===11 && current.host){
        segments.unshift('::shadow');
        current=current.host;
        continue;
      }
      if(current.nodeType!==1){
        break;
      }
      let segment=current.tagName?current.tagName.toLowerCase():'node';
      if(current.id){
        segment+=`#${current.id}`;
        segments.unshift(segment);
        break;
      }
      const dataKind=current.getAttribute && current.getAttribute('data-banner-kind');
      if(dataKind){
        segment+=`[data-banner-kind="${dataKind}"]`;
      }
      const dataBanner=current.getAttribute && current.getAttribute('data-banner');
      if(dataBanner && !dataKind){
        segment+=`[data-banner="${dataBanner}"]`;
      }
      const className=(current.className && typeof current.className==='string')?current.className.trim():'';
      if(className){
        const firstClass=className.split(/\s+/).filter(Boolean)[0];
        if(firstClass){
          segment+=`.${firstClass}`;
        }
      }
      if(current.parentNode && current.parentNode.children){
        const siblings=Array.from(current.parentNode.children).filter(child=>child.tagName===current.tagName);
        if(siblings.length>1){
          const index=siblings.indexOf(current);
          segment+=`:nth-of-type(${index+1})`;
        }
      }
      segments.unshift(segment);
      if(current===document.documentElement){
        segments.unshift('html');
        break;
      }
      current=current.parentNode || null;
    }
    if(segments.length && segments[0]!=='html' && document && document.documentElement){
      segments.unshift('html');
    }
    return segments.join(' > ');
  }

  function computeNodeRect(node){
    const fallback={x:null,y:null,w:null,h:null};
    if(!node || typeof node.getBoundingClientRect!=='function') return fallback;
    try {
      const rect=node.getBoundingClientRect();
      return {
        x:Math.round(rect.x*100)/100,
        y:Math.round(rect.y*100)/100,
        w:Math.round(rect.width*100)/100,
        h:Math.round(rect.height*100)/100
      };
    } catch (_) {
      return fallback;
    }
  }

  function computeNodeStyles(node){
    const styles={display:null,visibility:null,opacity:null,zIndex:null,pointerEvents:null,position:null};
    if(!node) return styles;
    try {
      if(window && typeof window.getComputedStyle==='function'){
        const computed=window.getComputedStyle(node);
        styles.display=computed.display;
        styles.visibility=computed.visibility;
        styles.opacity=computed.opacity;
        styles.zIndex=computed.zIndex;
        styles.pointerEvents=computed.pointerEvents;
        styles.position=computed.position;
      }
    } catch (_) {
      /* noop */
    }
    return styles;
  }

  function describeErrorNode(node,idx){
    if(!node){
      return {
        idx,
        path:'missing',
        textSample:'',
        inShadowRoot:false,
        rect:{x:null,y:null,w:null,h:null},
        styles:{display:null,visibility:null,opacity:null,zIndex:null,pointerEvents:null,position:null},
        attrs:{id:null,class:null,hidden:null,'aria-hidden':null,inert:null,'data-banner':null,'data-ai-review-guarded':null}
      };
    }
    const text=normalizeErrorText(node.textContent||'');
    const rect=computeNodeRect(node);
    const styles=computeNodeStyles(node);
    const attrs={};
    try { attrs.id=node.id||null; } catch (_) { attrs.id=null; }
    try { attrs.class=(node.getAttribute && node.getAttribute('class'))||null; } catch (_) { attrs.class=null; }
    try { attrs.hidden=node.hasAttribute && node.hasAttribute('hidden'); } catch (_) { attrs.hidden=null; }
    try { attrs['aria-hidden']=node.getAttribute && node.getAttribute('aria-hidden'); } catch (_) { attrs['aria-hidden']=null; }
    try { attrs.inert=node.hasAttribute && node.hasAttribute('inert'); } catch (_) { attrs.inert=null; }
    try { attrs['data-banner']=node.getAttribute && node.getAttribute('data-banner'); } catch (_) { attrs['data-banner']=null; }
    try { attrs['data-ai-review-guarded']=node.getAttribute && node.getAttribute('data-ai-review-guarded'); } catch (_) { attrs['data-ai-review-guarded']=null; }
    return {
      idx,
      path:computeNodePath(node),
      textSample:text.slice(0,80),
      inShadowRoot:nodeIsInShadowRoot(node),
      rect,
      styles,
      attrs
    };
  }

  function scanForErrorTextNodes(){
    const matches=[];
    const nodes=[];
    const visited=new Set();
    const targetText=normalizeErrorText(DEFAULT_ERROR_MESSAGE);
    function visit(node){
      if(!node || visited.has(node)) return;
      visited.add(node);
      if(node.nodeType===1){
        const normalized=normalizeErrorText(node.textContent||'');
        if(normalized.includes(targetText)){
          nodes.push(node);
          matches.push(describeErrorNode(node,matches.length));
        }
        if(node.shadowRoot){
          visit(node.shadowRoot);
        }
        const children=node.children?Array.from(node.children):[];
        children.forEach(child=>visit(child));
      } else if(node.nodeType===11){
        const childNodes=node.childNodes?Array.from(node.childNodes):[];
        childNodes.forEach(child=>visit(child));
      }
    }
    try {
      visit(document.documentElement);
    } catch (_) {
      /* noop */
    }
    return { log:{foundCount:matches.length,nodes:matches}, nodes };
  }

  function isNodeVisiblyRendered(node){
    if(!node || node.nodeType!==1) return false;
    try {
      if(node.hasAttribute && node.hasAttribute('hidden')) return false;
      if(typeof node.hidden==='boolean' && node.hidden) return false;
    } catch (_) {
      /* noop */
    }
    let styles;
    try {
      styles=window && typeof window.getComputedStyle==='function' ? window.getComputedStyle(node) : null;
    } catch (_) {
      styles=null;
    }
    if(styles){
      if(styles.display==='none') return false;
      if(styles.visibility==='hidden' || styles.visibility==='collapse') return false;
      const opacityValue=parseFloat(styles.opacity);
      if(!Number.isNaN(opacityValue) && opacityValue<=0) return false;
    }
    return true;
  }

  function guardErrorDuplicate(node){
    if(!node || node.nodeType!==1) return;
    try { node.setAttribute('aria-hidden','true'); } catch (_) { /* noop */ }
    try { node.setAttribute('data-ai-review-guarded','error'); } catch (_) { /* noop */ }
    if(node.style){
      try { node.style.display='none'; } catch (_) { /* noop */ }
    }
  }

  function evaluateHiddenOverride(node){
    const result={hiddenAttr:false,effectiveHidden:true,reason:'ok'};
    if(!node || node.nodeType!==1) return result;
    try {
      if(typeof node.hasAttribute==='function'){
        result.hiddenAttr=node.hasAttribute('hidden');
      } else if('hidden' in node){
        result.hiddenAttr=!!node.hidden;
      }
    } catch (_) {
      result.hiddenAttr=false;
    }
    if(!result.hiddenAttr){
      result.effectiveHidden=false;
      return result;
    }
    try {
      if(window && typeof window.getComputedStyle==='function'){
        const computed=window.getComputedStyle(node);
        const display=computed.display;
        const visibility=computed.visibility;
        if(display && display!=='none' || visibility && visibility!=='hidden'){
          result.effectiveHidden=false;
        }
      }
    } catch (_) {
      result.effectiveHidden=false;
    }
    if(!result.effectiveHidden){
      result.reason='css_override';
    }
    return result;
  }

  function logEmptyBanner(tag,payload){
    try {
      if(window && window.console && typeof window.console.info==='function'){
        window.console.info(`[ai_review.empty] ${tag}`, payload);
      }
    } catch (_) {
      /* noop */
    }
  }

  function describeBannerNode(node,index){
    if(!node) return `missing#${index}`;
    const id=node.id?`#${node.id}`:'';
    const dataKind=node.getAttribute('data-banner-kind');
    const label=node.getAttribute('aria-label') || node.getAttribute('data-banner');
    const tag=node.tagName?node.tagName.toLowerCase():'';
    const parts=[
      tag,
      id.trim(),
      dataKind?`[data-banner-kind="${dataKind}"]`:null,
      label?`"${label}"`:null
    ].filter(Boolean);
    return parts.length?parts.join(' '):`${tag||'node'}#${index}`;
  }

  function snapshotBannerNode(node){
    if(!node){
      return {
        exists:false,
        hiddenAttr:null,
        ariaHidden:null,
        inert:false,
        hasClassHidden:false,
        computedDisplay:'n/a'
      };
    }
    let computed='n/a';
    try {
      if(window && typeof window.getComputedStyle==='function'){
        computed=window.getComputedStyle(node).display;
      }
    } catch (_) {
      computed='n/a';
    }
    let hiddenAttr=false;
    try {
      if(typeof node.hasAttribute==='function'){
        hiddenAttr=node.hasAttribute('hidden');
      } else if(node.attributes && Object.prototype.hasOwnProperty.call(node.attributes,'hidden')){
        hiddenAttr=true;
      }
    } catch (_) {
      hiddenAttr=false;
    }
    let inertValue;
    try {
      if(typeof node.inert==='boolean'){
        inertValue=node.inert;
      } else if(typeof node.hasAttribute==='function'){
        inertValue=node.hasAttribute('inert');
      } else {
        inertValue=!!(node.attributes && Object.prototype.hasOwnProperty.call(node.attributes,'inert'));
      }
    } catch (_) {
      inertValue=false;
    }
    return {
      exists:true,
      hiddenAttr,
      ariaHidden:node.getAttribute('aria-hidden'),
      inert:!!inertValue,
      hasClassHidden:node.classList ? node.classList.contains('hidden') : false,
      computedDisplay:computed
    };
  }

  function setInert(node,value){
    try {
      if(value){
        node.setAttribute('inert','');
        if('inert' in node){ node.inert=true; }
      } else {
        node.removeAttribute('inert');
        if('inert' in node){ node.inert=false; }
      }
    } catch (_) {
      /* noop */
    }
  }

  function applyEmptyBannerVisibility({shouldShow,reason,phase,itemCount,retries,durationMs}){
    const candidates=Array.from(document.querySelectorAll('[data-empty-banner]'));
    const fallback=emptyState && !candidates.includes(emptyState) ? [emptyState] : [];
    const nodes=candidates.concat(fallback);
    const stateSnapshot={ phase, itemCount, retries, durationMs };
    logEmptyBanner('decision',{shouldShow,reason,state:stateSnapshot});
    if(nodes.length>1){
      logEmptyBanner('multiple_nodes',{
        count:nodes.length,
        nodes:nodes.map((node,index)=>describeBannerNode(node,index))
      });
    }
    const primary=nodes[0]||null;
    const before=snapshotBannerNode(primary);
    logEmptyBanner('dom_before', before);
    nodes.forEach((node,index)=>{
      if(!node) return;
      const showNode=shouldShow && node===primary;
      try {
        if(showNode){
          node.hidden=false;
          if(typeof node.removeAttribute==='function'){
            node.removeAttribute('hidden');
          } else if(node.attributes){
            delete node.attributes.hidden;
          }
          if(typeof node.setAttribute==='function'){
            node.setAttribute('aria-hidden','false');
          } else if(node.attributes){
            node.attributes['aria-hidden']='false';
          }
          setInert(node,false);
        } else {
          node.hidden=true;
          if(typeof node.setAttribute==='function'){
            node.setAttribute('hidden','');
            node.setAttribute('aria-hidden','true');
          } else if(node.attributes){
            node.attributes.hidden='';
            node.attributes['aria-hidden']='true';
          }
          setInert(node,true);
        }
      } catch (_) {
        /* noop */
      }
      if(index>0){
        node.hidden=true;
        if(typeof node.setAttribute==='function'){
          node.setAttribute('hidden','');
          node.setAttribute('aria-hidden','true');
        } else if(node.attributes){
          node.attributes.hidden='';
          node.attributes['aria-hidden']='true';
        }
        setInert(node,true);
      }
    });
    const after=snapshotBannerNode(primary);
    logEmptyBanner('dom_after', after);
    const remainsVisible=!shouldShow && after.exists && !after.hiddenAttr && after.computedDisplay!=='none' && after.computedDisplay!=='n/a';
    if(remainsVisible){
      logEmptyBanner('conflict',{
        reason:'visible_when_should_hide',
        snapshots:{before,after}
      });
    }
    return { primaryNode: primary, shouldShow: shouldShow && !!primary };
  }

  function applyCachedBannerVisibility({shouldShow,reason,message}){
    const nodes=Array.from(document.querySelectorAll('[data-banner-kind="cached"]'));
    const stateSnapshot={
      phase:state.loadOutcome.phase,
      itemCount:state.loadOutcome.itemCount,
      usingCache:state.loadOutcome.usingCache,
      networkWasOffline:state.loadOutcome.networkWasOffline,
      retries:state.loadOutcome.retries,
      durationMs:state.loadOutcome.durationMs
    };
    logCachedBanner('decision',{shouldShow,reason,state:stateSnapshot});
    if(nodes.length>1){
      logCachedBanner('multiple_nodes',{
        count:nodes.length,
        nodes:nodes.map((node,index)=>describeBannerNode(node,index))
      });
    }
    const primary=nodes[0]||null;
    const before=snapshotBannerNode(primary);
    logCachedBanner('dom_before',before);
    nodes.forEach(node=>{
      if(!node) return;
      if(shouldShow){
        node.removeAttribute('hidden');
        node.setAttribute('aria-hidden','false');
        node.setAttribute('data-banner-visible','true');
        setInert(node,false);
        if(message && degradedMessage && node.contains(degradedMessage)){
          degradedMessage.textContent=message;
        }
      } else {
        node.setAttribute('hidden','');
        node.setAttribute('aria-hidden','true');
        node.removeAttribute('data-banner-visible');
        setInert(node,true);
      }
    });
    const after=snapshotBannerNode(primary);
    logCachedBanner('dom_after',after);
    const visibleAfter=!shouldShow && after.exists && !after.hiddenAttr && after.computedDisplay!=='none' && after.computedDisplay!=='n/a';
    if(visibleAfter){
      logCachedBanner('conflict',{
        reason:'visible_when_should_hide',
        snapshots:{before,after}
      });
    }
  }

  function evaluateErrorBannerDecision({phase,retries,maxRetries,lastErrorCode,lastErrorMessage,durationMs}){
    const numericRetries=Number.isFinite(Number(retries))?Number(retries):0;
    const numericMax=Number.isFinite(Number(maxRetries))?Number(maxRetries):null;
    const isErrorPhase=phase==='error';
    const hasBudget=numericMax!==null && numericRetries<numericMax;
    const shouldShow=isErrorPhase && !hasBudget;
    let reason='not_error';
    if(isErrorPhase){
      reason=hasBudget?'transient_retry':'final_error';
    }
    const stateSnapshot={
      phase,
      retries:numericRetries,
      durationMs:Number.isFinite(Number(durationMs))?Number(durationMs):0
    };
    if(numericMax!==null){
      stateSnapshot.maxRetries=numericMax;
    }
    if(typeof lastErrorCode!=='undefined'){
      stateSnapshot.lastErrorCode=lastErrorCode===undefined?null:lastErrorCode;
    }
    if(typeof lastErrorMessage!=='undefined'){
      stateSnapshot.lastErrorMessage=lastErrorMessage||'';
    }
    return { shouldShow, reason, state:stateSnapshot };
  }

  function applyErrorBannerVisibility({decision,message,messageNode}){
    const target=errorState||null;
    logErrorBanner('decision',{shouldShow:decision.shouldShow,reason:decision.reason,state:decision.state});

    const scanBefore=scanForErrorTextNodes();
    logErrorBanner('dom_scan_before',scanBefore.log);

    const targetBefore=describeErrorNode(target,0);
    logErrorBanner('target_dom_before',targetBefore);

    const duplicateEntries=scanBefore.log.nodes
      .map((info,index)=>({info,index,node:scanBefore.nodes[index]}))
      .filter(({node})=>{
        if(!node) return false;
        if(node===target) return false;
        if(target && typeof target.contains==='function' && target.contains(node)) return false;
        if(target && typeof node.contains==='function' && node.contains(target)) return false;
        return true;
      });

    if(duplicateEntries.length){
      logErrorBanner('multiple_nodes',{
        count:duplicateEntries.length,
        nodes:duplicateEntries.map(entry=>entry.info.path)
      });
    }

    duplicateEntries.forEach(({node})=>guardErrorDuplicate(node));

    if(target){
      try {
        if(decision.shouldShow){
          target.hidden=false;
          if(typeof target.removeAttribute==='function'){
            target.removeAttribute('hidden');
            target.setAttribute('aria-hidden','false');
            target.removeAttribute('data-ai-review-guarded');
          }
          if(target.style){
            try { target.style.removeProperty('display'); } catch (_) { /* noop */ }
          }
          setInert(target,false);
          if(typeof target.setAttribute==='function'){
            target.setAttribute('data-banner-visible','true');
          }
          const textNode=messageNode || (typeof target.querySelector==='function' ? target.querySelector('p') : null);
          if(textNode && message){
            try { textNode.textContent=message; } catch (_) { /* noop */ }
          }
        } else {
          if(typeof target.setAttribute==='function'){
            target.setAttribute('hidden','');
            target.setAttribute('aria-hidden','true');
            target.removeAttribute('data-banner-visible');
          }
          target.hidden=true;
          setInert(target,true);
          if(target.style){
            try { target.style.removeProperty('display'); } catch (_) { /* noop */ }
          }
        }
      } catch (_) {
        /* noop */
      }
    }

    let cssCheck=evaluateHiddenOverride(target);
    if(!decision.shouldShow && cssCheck.hiddenAttr && !cssCheck.effectiveHidden){
      if(target && target.style){
        try { target.style.display='none'; } catch (_) { /* noop */ }
      }
      cssCheck.reason='css_override';
    }
    logErrorBanner('css_override_check',cssCheck);

    const targetAfter=describeErrorNode(target,0);
    logErrorBanner('target_dom_after',targetAfter);

    const scanAfter=scanForErrorTextNodes();
    logErrorBanner('dom_scan_after',scanAfter.log);

    if(!decision.shouldShow){
      const survivors=scanAfter.log.nodes
        .map((info,index)=>({info,node:scanAfter.nodes[index]}))
        .filter(({node})=>{
          if(!node) return false;
          if(node===target) return isNodeVisiblyRendered(node);
          if(target){
            if(typeof target.contains==='function' && target.contains(node)){
              return isNodeVisiblyRendered(node);
            }
            if(typeof node.contains==='function' && node.contains(target)){
              return false;
            }
          }
          return isNodeVisiblyRendered(node);
        });
      if(survivors.length){
        logErrorBanner('conflict',{
          reason:'visible_when_should_hide',
          survivors:survivors.map(({info})=>info)
        });
        survivors.forEach(({node})=>{
          if(!node) return;
          if(node!==target && !(target && typeof target.contains==='function' && target.contains(node)) && !(target && typeof node.contains==='function' && node.contains(target))){
            guardErrorDuplicate(node);
          } else if(target && node===target && target.style){
            try { target.style.display='none'; } catch (_) { /* noop */ }
          }
        });
      }
    }

    return {
      shouldShow:decision.shouldShow && !!target,
      primaryNode:decision.shouldShow && target ? target : null
    };
  }

  function updateLoadOutcome(updates={}){
    const next={
      ...state.loadOutcome,
      ...updates,
      timestamp:new Date().toISOString()
    };
    const phaseChanged=next.phase!==state.loadOutcome.phase;
    state.loadOutcome=next;
    if(phaseChanged){
      logStateSnapshot();
    }
  }

  function navigatorOnline(){
    if(typeof navigator==='undefined' || typeof navigator.onLine!=='boolean') return true;
    return navigator.onLine;
  }

  function viewToPhase(view){
    switch(view){
      case VIEW_STATES.ERROR:
        return 'error';
      case VIEW_STATES.DEGRADED:
        return 'success';
      case VIEW_STATES.LOADING:
        return 'loading';
      case VIEW_STATES.IDLE:
        return 'idle';
      default:
        return 'success';
    }
  }

  const REFRESH_INTERVAL = window.AutoRefresh ? window.AutoRefresh.DEFAULT_INTERVAL : 15000;
  const RETRY_DELAYS_MS=[600,1500];
  let autoRefreshController = null;
  let activeLoadTimer=null;
  let activeRetryTimer=null;

  const groupContainer=document.getElementById('groupContainer');
  const loadingState=document.getElementById('loadingState');
  const emptyState=document.getElementById('emptyState');
  const errorState=document.getElementById('errorState');
  const reviewContent=document.getElementById('reviewContent');
  const filterButtons=Array.from(document.querySelectorAll('[data-filter]'));
  const searchInput=document.getElementById('searchInput');
  const detailView=document.getElementById('detailView');
  const detailTitle=document.getElementById('detailTitle');
  const detailMeta=document.getElementById('detailMeta');
  const detailBody=document.getElementById('detailBody');
  const detailSynopsis=document.getElementById('detailSynopsis');
  const detailTag=document.getElementById('detailTag');
  const detailCrumb=document.getElementById('detailCrumb');
  const detailAiMeta=document.getElementById('detailAiMeta');
  const detailAiRequirements=document.getElementById('detailAiRequirements');
  const detailReassess=document.getElementById('detailReassess');
  const emptyRefresh=document.getElementById('emptyRefresh');
  const errorRetry=document.getElementById('errorRetry');
  const degradedBanner=document.getElementById('degradedBanner');
  const degradedMessage=document.getElementById('degradedMessage');
  const degradedRetry=document.getElementById('degradedRetry');
  const noResultsNotice=document.getElementById('noResultsNotice');
  const errorMessage=errorState?errorState.querySelector('p'):null;

  function normalizeItems(items){
    return Array.isArray(items) ? items.slice().sort((a,b)=>b.received-a.received) : [];
  }

  function fetchLatestItems(){
    const loader=(window.aiReviewDataSource && typeof window.aiReviewDataSource.fetch==='function')
      ? window.aiReviewDataSource.fetch
      : ()=>getEmails();
    return Promise.resolve().then(()=>loader());
  }

  function getRetryDelay(attemptNumber){
    if(!RETRY_DELAYS_MS.length) return 0;
    const index=Math.max(0, Math.min(RETRY_DELAYS_MS.length-1, attemptNumber-1));
    const delay=RETRY_DELAYS_MS[index];
    return Number.isFinite(delay) && delay>=0 ? delay : 0;
  }

  state.cachedItems=normalizeItems(getEmails());
  state.items=state.cachedItems.slice();

  function getCategory(item){
    const raw = item && item.ai ? item.ai.category : null;
    return AICategory.normalizeCategory(raw || item.aiCategory);
  }

  function formatTime(ts){ return new Date(ts).toLocaleString(); }

  function matchesSearch(item, term){
    if(!term) return true;
    const ai=item.ai||{};
    const hay=[
      item.subject,
      item.from,
      item.body,
      item.status,
      item.aiSynopsis,
      ai.notes,
      ...(ai.blockers||[]),
      ...(ai.required_permissions||[]),
      ...(ai.required_context||[])
    ].map(v=>String(v||'').toLowerCase()).join(' ');
    return hay.includes(term.toLowerCase());
  }

  function updateCounts(items){
    const counts={green:0,blue:0,red:0,grey:0};
    items.forEach(item=>{ counts[getCategory(item)]++; });
    filterButtons.forEach(btn=>{
      const key=btn.getAttribute('data-filter');
      const badge=document.querySelector(`[data-count="${key}"]`);
      if(!badge) return;
      if(key==='all'){ badge.textContent=items.length; }
      else { badge.textContent=counts[key]||0; }
    });
  }

  function getFilteredItems(source){
    const list=Array.isArray(source)?source:state.items;
    return list.filter(item=>{
      const category=getCategory(item);
      if(state.filter!=='all' && category!==state.filter) return false;
      return matchesSearch(item, state.search);
    });
  }

  function renderList(filtered){
    if(!filtered || !filtered.length){
      groupContainer.innerHTML='';
      return false;
    }

    const groups=['green','blue','red','grey'];
    const markup=groups
      .map(groupKey=>{
        const groupItems=filtered.filter(item=>getCategory(item)===groupKey);
        if(!groupItems.length) return '';
        const presentation=AICategory.getCategoryPresentation(groupKey);
        const cards=groupItems.map(item=>{
          const ai=item.ai||{};
          const synopsis=ai.notes || item.aiSynopsis || 'Metadata pending for this message.';
          const confidence=formatConfidence(ai);
          const metaParts=[`From ${escapeHtml(item.from)}`,`Status: ${escapeHtml(item.status)}`];
          if(confidence){ metaParts.push(`Confidence: ${confidence}`); }
          if(item.ai && item.ai.assessor_version === 'manual-override'){
            metaParts.push('Manual override');
          }
          const itemCategory=getCategory(item);
          const stripe=AICategory.getCategoryPresentation(itemCategory);
          const stripeClass=stripe.stripeClass || `card-stripe-${itemCategory}`;
          return `<button class="card" data-id="${item.id}">
            <span class="card-stripe ${stripeClass}" aria-label="${escapeHtml(stripe.title)}"></span>
            <div class="card-content">
              <div class="card-header">
                <span class="timestamp">${formatTime(item.received)}</span>
              </div>
              <div class="title-text">${escapeHtml(item.subject)}</div>
              <p class="description">${escapeHtml(synopsis)}</p>
              <div class="meta">${metaParts.join(' • ')}</div>
            </div>
            <span class="chev">${'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 6l6 6-6 6"/></svg>'}</span>
          </button>`;
        }).join('');
        return `<div class="group">
          <div class="group-header">
            <div class="group-title">${escapeHtml(presentation.title)} <span class="group-count">${groupItems.length} items</span></div>
            <p class="group-description">${escapeHtml(presentation.description)}</p>
          </div>
          <div class="group-cards">${cards}</div>
        </div>`;
      }).join('');
    groupContainer.innerHTML=markup;
    groupContainer.querySelectorAll('.card[data-id]').forEach(btn=>{
      btn.addEventListener('click',()=>openDetail(btn.getAttribute('data-id')));
    });
    return true;
  }

  function render(){
    const phase=state.loadOutcome.phase;
    const usingCache=state.loadOutcome.usingCache;
    const networkWasOffline=state.loadOutcome.networkWasOffline;
    const errorDecision=evaluateErrorBannerDecision({
      phase,
      retries:state.loadOutcome.retries,
      maxRetries:state.loadOutcome.maxRetries,
      lastErrorCode:state.loadOutcome.lastErrorCode,
      lastErrorMessage:state.loadOutcome.lastErrorMessage || state.errorMessage,
      durationMs:state.loadOutcome.durationMs
    });
    const isLoading=(phase==='loading') || (phase==='error' && errorDecision.reason==='transient_retry');
    const shouldRenderList=(phase==='success' && state.items.length>0);

    if(!isLoading){
      updateCounts(state.items);
    }

    const filteredItems=shouldRenderList ? getFilteredItems(state.items) : [];
    const hasVisible=shouldRenderList && filteredItems.length>0;

    const showLoading=isLoading;
    const shouldShowEmpty=(phase==='success' && state.loadOutcome.itemCount===0);
    let emptyReason='not_success';
    if(phase==='success'){
      emptyReason=state.loadOutcome.itemCount===0?'success_zero':'has_items';
    }
    const showCached=(phase==='success' && usingCache && state.loadOutcome.itemCount>0);
    const showError=errorDecision.shouldShow;
    const showNoResults=shouldRenderList && state.items.length>0 && !hasVisible;

    const nextBannerKind=shouldShowEmpty ? 'empty' : showCached ? 'cached' : showError ? 'error' : null;
    state.ui.banner.kind=nextBannerKind;

    const bannerFlags={
      empty:nextBannerKind==='empty',
      degraded:nextBannerKind==='cached',
      error:nextBannerKind==='error'
    };
    const activeBanners=Object.entries(bannerFlags)
      .filter(([,value])=>value)
      .map(([key])=>key);
    let chosen='none';
    let reason='no_banner';
    if(showLoading){
      reason='loading';
    } else if(nextBannerKind){
      if(nextBannerKind==='empty'){ chosen='info_empty'; reason='success_empty'; }
      else if(nextBannerKind==='cached'){ chosen='warn_cached'; reason=networkWasOffline?'cache_offline':'cache_used'; }
      else if(nextBannerKind==='error'){ chosen='error_failed'; reason='error_final'; }
    } else if(phase==='success' && state.loadOutcome.itemCount>0){
      reason='success_items';
    }

    logBannerDecision({
      chosen,
      reason,
      active:activeBanners,
      snapshot:{
        phase:state.loadOutcome.phase,
        itemCount:state.loadOutcome.itemCount,
        usingCache,
        retries:state.loadOutcome.retries,
        durationMs:state.loadOutcome.durationMs,
        networkWasOffline,
        filter:state.filter,
        search:state.search,
        totalItems:state.items.length,
        filteredCount:filteredItems.length,
        detailOpen:!!state.detailId
      }
    });

    if(activeBanners.length>1){
      logBannerConflict(activeBanners);
    } else if(activeBanners.length===0){
      lastConflictLog='';
    }

    if(loadingState){
      loadingState.hidden=!showLoading;
    }

    if(groupContainer){
      if(hasVisible){
        renderList(filteredItems);
        groupContainer.hidden=false;
      } else {
        if(!showLoading){
          groupContainer.innerHTML='';
        }
        groupContainer.hidden=true;
      }
    }

    if(noResultsNotice){
      noResultsNotice.hidden=!showNoResults;
    }

    const emptyResult=applyEmptyBannerVisibility({
      shouldShow: shouldShowEmpty,
      reason: emptyReason,
      phase,
      itemCount: state.loadOutcome.itemCount,
      retries: state.loadOutcome.retries,
      durationMs: state.loadOutcome.durationMs
    });
    if(emptyResult.shouldShow && emptyResult.primaryNode && state.lastView!==VIEW_STATES.EMPTY && typeof emptyResult.primaryNode.focus==='function'){
      emptyResult.primaryNode.focus();
    }

    const errorMessageText=state.errorMessage || state.loadOutcome.lastErrorMessage || DEFAULT_ERROR_MESSAGE;
    const errorResult=applyErrorBannerVisibility({
      decision:errorDecision,
      message:errorMessageText,
      messageNode:errorMessage
    });
    if(errorResult.shouldShow && state.lastView!==VIEW_STATES.ERROR && errorResult.primaryNode && typeof errorResult.primaryNode.focus==='function'){
      errorResult.primaryNode.focus();
    }

    const cachedVisibilityReason=(nextBannerKind==='cached')
      ? (networkWasOffline ? 'usingCache+offline' : 'usingCache_active')
      : !usingCache
        ? 'usingCache_false'
        : !networkWasOffline
          ? 'network_online'
          : phase!=='success'
            ? `phase_${phase}`
            : state.loadOutcome.itemCount<=0
              ? 'no_items'
              : 'suppressed';
    applyCachedBannerVisibility({
      shouldShow:nextBannerKind==='cached',
      reason:cachedVisibilityReason,
      message:state.errorMessage || 'Showing cached results while we reconnect…'
    });

    if((state.view===VIEW_STATES.ERROR || state.view===VIEW_STATES.EMPTY) && (errorResult.shouldShow || shouldShowEmpty)){
      closeDetail();
    }

    state.lastView=state.view;
  }

  function setItems(items,{cache=false}={}){
    state.items=normalizeItems(items);
    if(cache){
      state.cachedItems=state.items.slice();
    }
  }

  function renderDetail(email,{scrollIntoView=true}={}){
    if(!email){
      closeDetail();
      return;
    }
    const category=getCategory(email);
    const info=CATEGORY_INFO[category] || CATEGORY_INFO.grey;
    const presentation=AICategory.getCategoryPresentation(category);
    const ai=email.ai||{};
    const confidence=formatConfidence(ai) || '–';
    const assessed=ai.assessed_at ? new Date(ai.assessed_at).toLocaleString() : '–';
    const assessor=ai.assessor_version || 'unknown';
    const blockers=formatList(ai.blockers);
    const permissions=formatList(ai.required_permissions);
    const context=formatList(ai.required_context);
    detailTitle.textContent=email.subject;
    detailMeta.innerHTML=`<strong>From:</strong> ${escapeHtml(email.from)} • <strong>Received:</strong> ${formatTime(email.received)} • <strong>Status:</strong> ${escapeHtml(email.status)} • <strong>AI:</strong> ${escapeHtml(presentation.title)} (${category.toUpperCase()} • ${confidence} confidence)`;
    detailBody.textContent=email.body;
    detailSynopsis.textContent=ai.notes || email.aiSynopsis || 'Metadata pending for this message.';
    const assessorLabel=escapeHtml(assessor);
    const overrideBanner=assessor==='manual-override' ? ' • Manual override active' : '';
    detailAiMeta.textContent=`Assessed ${assessed} • Assessor: ${assessorLabel} • Confidence: ${confidence}${overrideBanner}`;
    detailAiRequirements.textContent=`Blockers: ${escapeHtml(blockers)} • Permissions: ${escapeHtml(permissions)} • Context: ${escapeHtml(context)}`;
    detailTag.textContent=`${presentation.title} • ${info.detail}`;
    detailTag.className=`detail-tag ${category}`;
    detailCrumb.textContent=email.subject;
    state.detailId=email.id;
    reviewContent.hidden=true;
    detailView.setAttribute('aria-hidden','false');
    if(scrollIntoView){
      detailView.scrollIntoView({behavior:'smooth',block:'start'});
    }
  }

  function normalizeLoadError(err){
    if(!err) return { message:DEFAULT_ERROR_MESSAGE, code:null };
    if(typeof err==='string'){
      return { message:err, code:null };
    }
    const message=err && typeof err.message==='string' && err.message.trim()
      ? err.message
      : DEFAULT_ERROR_MESSAGE;
    const code=(err && (err.code ?? err.status)) || (err && typeof err.name==='string' ? err.name : null);
    return { message, code:code ?? null };
  }

  function load(){
    if(state.pendingLoad) return;
    if(activeRetryTimer){
      clearTimeout(activeRetryTimer);
      activeRetryTimer=null;
    }
    state.pendingLoad=true;
    state.view=VIEW_STATES.LOADING;
    state.errorMessage='';
    const initialOffline=!navigatorOnline();
    const maxRetries=Math.max(0, RETRY_DELAYS_MS.length);
    const attempt={
      retries:0,
      maxRetries,
      settled:false,
      networkWasOffline:initialOffline
    };
    updateLoadOutcome({
      phase:'loading',
      usingCache:false,
      retries:0,
      maxRetries:attempt.maxRetries,
      itemCount:state.items.length,
      durationMs:0,
      networkWasOffline:initialOffline,
      lastErrorCode:null,
      lastErrorMessage:''
    });
    render();
    const start=typeof performance!=='undefined' && performance.now ? performance.now() : Date.now();
    if(activeLoadTimer){
      clearTimeout(activeLoadTimer);
      activeLoadTimer=null;
    }
    const markOffline=()=>{ attempt.networkWasOffline=true; };
    if(typeof window!=='undefined' && window.addEventListener){
      window.addEventListener('offline', markOffline);
    }
    const cleanup=()=>{
      if(typeof window!=='undefined' && window.removeEventListener){
        window.removeEventListener('offline', markOffline);
      }
    };
    const finalize=({phase,usingCache,itemCount,errorMessage,errorCode})=>{
      if(attempt.settled) return;
      attempt.settled=true;
      cleanup();
      if(activeLoadTimer){
        clearTimeout(activeLoadTimer);
        activeLoadTimer=null;
      }
      if(activeRetryTimer){
        clearTimeout(activeRetryTimer);
        activeRetryTimer=null;
      }
      state.pendingLoad=false;
      const end=typeof performance!=='undefined' && performance.now ? performance.now() : Date.now();
      const duration=Math.max(1, Math.round(end-start));
      if(errorMessage){
        state.errorMessage=errorMessage;
      }
      updateLoadOutcome({
        phase,
        usingCache:!!usingCache,
        itemCount,
        retries:attempt.retries,
        maxRetries:attempt.maxRetries,
        durationMs:duration,
        networkWasOffline:attempt.networkWasOffline || !navigatorOnline(),
        lastErrorCode:errorCode ?? null,
        lastErrorMessage:errorMessage || ''
      });
      try {
        const status=phase!=='success'
          ? 'error'
          : usingCache
            ? 'degraded'
            : itemCount===0
              ? 'empty'
              : 'success';
        telemetry.log('ai_review_load',{
          phase,
          itemCount,
          durationMs:duration,
          retries:attempt.retries,
          usingCache:!!usingCache,
          status
        });
      } catch (err) {
        /* ignore telemetry errors */
      }
    };
    const handleSuccess=items=>{
      if(attempt.settled) return;
      setItems(Array.isArray(items)?items:[],{cache:true});
      const nextView=state.items.length?VIEW_STATES.SUCCESS:VIEW_STATES.EMPTY;
      state.view=nextView;
      state.errorMessage='';
      finalize({phase:'success',usingCache:false,itemCount:state.items.length,errorMessage:'',errorCode:null});
      render();
      ensureAutoRefresh();
    };
    const scheduleRetry=()=>{
      const delay=getRetryDelay(attempt.retries);
      if(activeRetryTimer){
        clearTimeout(activeRetryTimer);
      }
      activeRetryTimer=setTimeout(()=>{
        activeRetryTimer=null;
        if(attempt.settled) return;
        beginAttempt();
      },delay);
    };
    const handleFailure=error=>{
      if(attempt.settled) return;
      if(activeLoadTimer){
        clearTimeout(activeLoadTimer);
        activeLoadTimer=null;
      }
      const { message:errorMsg, code:errorCode }=normalizeLoadError(error);
      state.errorMessage=errorMsg;
      const now=typeof performance!=='undefined' && performance.now ? performance.now() : Date.now();
      const duration=Math.max(1, Math.round(now-start));
      const hasRetries=attempt.retries<attempt.maxRetries;
      if(hasRetries){
        attempt.retries+=1;
        state.view=VIEW_STATES.LOADING;
        updateLoadOutcome({
          phase:'error',
          usingCache:false,
          itemCount:state.items.length,
          retries:attempt.retries,
          maxRetries:attempt.maxRetries,
          durationMs:duration,
          networkWasOffline:attempt.networkWasOffline || !navigatorOnline(),
          lastErrorCode:errorCode ?? null,
          lastErrorMessage:errorMsg
        });
        logErrorBanner('retry_progress',{
          attempt:attempt.retries,
          maxRetries:attempt.maxRetries,
          nextDelayMs:getRetryDelay(attempt.retries)
        });
        render();
        scheduleRetry();
        return;
      }
      let usingCache=false;
      let phaseLabel='error';
      let errorCodeValue=errorCode ?? null;
      if(state.cachedItems.length){
        state.items=state.cachedItems.slice();
        state.view=VIEW_STATES.DEGRADED;
        usingCache=true;
        phaseLabel='success';
      } else {
        state.items=[];
        state.view=VIEW_STATES.ERROR;
      }
      finalize({
        phase:phaseLabel,
        usingCache,
        itemCount:state.items.length,
        errorMessage:errorMsg,
        errorCode:errorCodeValue
      });
      render();
      ensureAutoRefresh();
    };
    const beginAttempt=()=>{
      if(attempt.settled) return;
      if(activeLoadTimer){
        clearTimeout(activeLoadTimer);
      }
      activeLoadTimer=setTimeout(()=>{
        if(attempt.settled) return;
        handleFailure({ message:DEFAULT_ERROR_MESSAGE, code:'timeout' });
      },LOAD_TIMEOUT_MS);
      fetchLatestItems()
        .then(handleSuccess)
        .catch(handleFailure);
    };
    beginAttempt();
  }

  function syncAndRender({skipScroll=false}={}){
    try {
      const data=getEmails();
      setItems(data,{cache:true});
      if(state.view!==VIEW_STATES.DEGRADED){
        state.view=state.items.length?VIEW_STATES.SUCCESS:VIEW_STATES.EMPTY;
        state.errorMessage='';
      }
    } catch (err){
      const message=err && err.message ? err.message : DEFAULT_ERROR_MESSAGE;
      state.errorMessage=message;
      if(state.cachedItems.length){
        state.items=state.cachedItems.slice();
        state.view=VIEW_STATES.DEGRADED;
      } else {
        state.items=[];
        state.view=VIEW_STATES.ERROR;
      }
    }
    const nextPhase=viewToPhase(state.view);
    const updates={};
    if(state.loadOutcome.itemCount!==state.items.length){
      updates.itemCount=state.items.length;
    }
    if(nextPhase!==state.loadOutcome.phase){
      updates.phase=nextPhase;
    }
    const shouldFlagCache=state.view===VIEW_STATES.DEGRADED;
    if(state.loadOutcome.usingCache!==shouldFlagCache){
      updates.usingCache=shouldFlagCache;
    }
    if(Object.keys(updates).length){
      updateLoadOutcome(updates);
    }
    render();
    if(state.view===VIEW_STATES.ERROR){
      return;
    }
    if(state.detailId){
      const email=state.items.find(item=>item.id===state.detailId);
      if(email){
        renderDetail(email,{scrollIntoView:!skipScroll});
      } else {
        closeDetail();
      }
    }
  }

  function ensureAutoRefresh(){
    if(!window.AutoRefresh || autoRefreshController) return;
    autoRefreshController=window.AutoRefresh.createAutoRefresh({
      refresh:()=>load(),
      intervalMs:REFRESH_INTERVAL,
      immediate:false,
      autoStart:false
    });
    autoRefreshController.start();
  }

  function setFilter(value){
    state.filter=value;
    filterButtons.forEach(btn=>{
      const pressed=btn.getAttribute('data-filter')===value;
      btn.setAttribute('aria-pressed', pressed?'true':'false');
    });
    render();
  }

  filterButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const value=btn.getAttribute('data-filter');
      setFilter(value);
    });
  });

  searchInput.addEventListener('input',()=>{
    state.search=searchInput.value.trim().toLowerCase();
    render();
  });

  function openDetail(id, options={}){
    const email=state.items.find(item=>item.id===id);
    if(!email){
      closeDetail();
      return;
    }
    renderDetail(email,options);
  }

  function closeDetail(){
    reviewContent.hidden=false;
    detailView.setAttribute('aria-hidden','true');
    state.detailId=null;
  }

  document.getElementById('detailBack').addEventListener('click',closeDetail);
  document.getElementById('detailBackBtn').addEventListener('click',closeDetail);

  if(emptyRefresh){
    emptyRefresh.addEventListener('click',()=>load());
  }
  if(errorRetry){
    errorRetry.addEventListener('click',()=>load());
  }
  if(degradedRetry){
    degradedRetry.addEventListener('click',()=>load());
  }

  if(detailReassess){
    detailReassess.addEventListener('click',()=>{
      if(!state.detailId) return;
      const updated=reassessEmail(state.detailId);
      if(updated){
        syncAndRender({skipScroll:true});
      }
    });
  }

  load();
  }
</script>
</body>
</html>
