<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI Review</title>
<style>
  :root {
    --radius:14px;
    --gap:12px;
    --focus:#6ea4e8;
    --page-pad:clamp(16px,3vw,28px);
    --footer-offset:120px;
    --footer-safe-area:env(safe-area-inset-bottom);
    --card-stripe:clamp(6px,1vw,10px);
  }
  :root, html[data-theme="dark"] {
    --bg:#141b26; --panel:#1a2330; --ink:#f4f7fb; --text:#d7dee7; --muted:#a5b3c5;
    --line:#364353; --card:#1d2735; --card-hover:#243041; --banner:#1b2534;
    --detail:#202b3b; --btn:#232f3f; --btn-hover:#2a3749; --accent-muted:#93a5bb;
    --red:#ea7c76; --green:#5ec49d; --blue:#78aeea; --amber:#e7ad6a; --crimson:#ed8a7d;
    --grey:#8a97ab; --shadow:0 6px 24px rgba(6,11,20,.32);
  }
  html[data-theme="light"] {
    --bg:#f2f4f7; --panel:#ffffff; --ink:#1e2936; --text:#2e3a4c; --muted:#647184;
    --line:#d0d7e2; --card:#ffffff; --card-hover:#f5f7fa; --banner:#f1f3f7;
    --detail:#f7f9fc; --btn:#eceff5; --btn-hover:#e1e5ed; --accent-muted:#7b889b;
    --red:#c6615b; --green:#3c8f6b; --blue:#3a7bd5; --amber:#c38b44; --crimson:#c46f63;
    --grey:#6b778a; --shadow:0 4px 18px rgba(15,23,42,.08); --focus:#3a7bd5;
  }
  *{box-sizing:border-box} html,body{height:100%}
  html{scroll-padding-bottom:calc(var(--footer-offset) + var(--footer-safe-area) + 12px)}
  body{margin:0;background:var(--bg);color:var(--text);
    font: clamp(15px,1.6vw,17px)/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    display:grid;place-items:center;padding:var(--page-pad);
    padding-bottom:calc(var(--page-pad) + var(--footer-safe-area) + var(--footer-offset));
    transition:background .2s,color .2s}
  .frame{width:min(1100px,98vw);background:var(--panel);border:2px solid var(--line);
    border-radius:18px;padding:clamp(12px,2.2vw,18px);box-shadow:var(--shadow);
    display:grid;gap:clamp(12px,2.2vw,18px)}
  .inner{display:grid;gap:clamp(14px,2vw,18px);background:var(--panel);
    border:2px solid var(--line);border-radius:14px;padding:clamp(14px,2vw,20px)}

  .global-menu{display:flex;align-items:center;justify-content:space-between;
    padding:clamp(10px,1.8vw,14px) clamp(12px,2.2vw,16px);background:var(--banner);
    border:2px solid var(--line);border-radius:12px;flex-wrap:wrap;gap:12px}
  .global-title{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px;
    font-size:clamp(18px,2.2vw,21px);color:var(--ink)}
  .global-nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;margin-left:auto}
  .link{color:var(--ink);text-decoration:none;font-weight:700;padding:8px 12px;border-radius:10px;border:2px solid var(--line);
    background:var(--btn);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;min-height:40px}
  .link:hover{background:var(--btn-hover)}
  .link[aria-current="page"]{background:var(--ink);color:var(--bg);border-color:var(--ink)}
  .toggle{width:54px;height:30px;border-radius:100px;border:2px solid var(--line);background:var(--btn);position:relative;cursor:pointer}
  .toggle:hover{background:var(--btn-hover)}
  .toggle:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
  .knob{width:22px;height:22px;border-radius:50%;background:var(--ink);position:absolute;top:50%;transform:translateY(-50%);left:4px;transition:left .2s}
  html[data-theme="light"] .knob{left:28px}
  .app-footer{position:fixed;left:0;right:0;bottom:0;background:var(--banner);border-top:2px solid var(--line);
    padding:clamp(12px,2vw,18px) clamp(18px,3vw,28px);display:flex;flex-wrap:wrap;gap:12px;align-items:center;
    justify-content:space-between;z-index:100;box-shadow:0 -6px 18px rgba(6,11,20,.24)}
  .footer-meta{display:flex;flex-direction:column;gap:2px;color:var(--muted)}
  .footer-meta strong{color:var(--ink);font-size:clamp(14px,1.7vw,16px)}
  .footer-actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .footer-button{appearance:none;border:2px solid var(--line);background:var(--btn);color:var(--ink);
    padding:8px 14px;border-radius:10px;font-weight:700;cursor:pointer;min-height:40px;display:inline-flex;align-items:center;justify-content:center}
  .footer-button:hover{background:var(--btn-hover)}
  .footer-button[disabled]{opacity:.6;cursor:not-allowed}
  .footer-theme{display:flex;align-items:center;gap:10px}
  .footer-theme-label{color:var(--muted);font-weight:600}

  .section-banner{display:flex;align-items:center;justify-content:space-between;gap:14px;
    padding:clamp(12px,2vw,16px);background:var(--banner);border:2px solid var(--line);border-radius:12px}
  .section-title{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px;
    font-size:clamp(18px,2.4vw,22px);color:var(--ink);margin:0}
  .section-subtitle{margin:0;color:var(--muted);font-size:clamp(13px,1.6vw,15px)}

  .controls{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between;align-items:center}
  .filters{display:flex;flex-wrap:wrap;gap:8px}
  .pill{appearance:none;border:2px solid var(--line);background:var(--btn);color:var(--text);
    padding:8px 12px;border-radius:999px;font-weight:700;display:inline-flex;align-items:center;gap:8px;cursor:pointer;min-height:38px}
  .pill:hover{background:var(--btn-hover)}
  .pill[aria-pressed="true"]{background:var(--ink);color:var(--bg);border-color:var(--ink)}
  .pill-count{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;border-radius:999px;
    background:rgba(0,0,0,.25);color:var(--ink);font-size:12px;font-weight:700;padding:0 6px}
  .pill[aria-pressed="true"] .pill-count{background:rgba(0,0,0,.3);color:var(--bg)}
  .pill-green[aria-pressed="true"]{background:var(--green);border-color:var(--green);color:#0d1b12}
  .pill-red[aria-pressed="true"]{background:var(--red);border-color:var(--red);color:#2c0908}
  .pill-blue[aria-pressed="true"]{background:var(--blue);border-color:var(--blue);color:#081d2c}
  .pill-grey[aria-pressed="true"]{background:var(--grey);border-color:var(--grey);color:#07090d}
  .pill label{font-weight:inherit}
  .search{position:relative;display:inline-flex;align-items:center}
  .search input{width:min(260px,70vw);padding:10px 12px;border:2px solid var(--line);border-radius:10px;background:var(--card);color:var(--text);font:inherit}
  .search input::placeholder{color:var(--muted)}

  .sr-only{position:absolute;clip:rect(1px,1px,1px,1px);clip-path:inset(0 0 99.9% 99.9%);height:1px;width:1px;overflow:hidden;padding:0;border:0}

  .stack{display:grid;gap:16px}
  .group{display:grid;gap:12px}
  .group-title{font-weight:800;color:var(--ink);font-size:clamp(16px,2vw,19px);display:flex;gap:10px;align-items:center}
  .group-count{font-size:13px;color:var(--muted);font-weight:600}
  .group-cards{display:grid;gap:12px}

  .card{display:grid;grid-template-columns:var(--card-stripe) 1fr auto;gap:0;align-items:stretch;
    padding:0;background:var(--card);border-radius:var(--radius);border:2px solid var(--line);
    cursor:pointer;transition:background .15s,transform .05s,border-color .2s;text-align:left;overflow:hidden}
  .card:hover{background:var(--card-hover);transform:translateY(-1px)}
  .card:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
  .card-stripe{width:var(--card-stripe);min-width:var(--card-stripe);background:var(--grey);align-self:stretch}
  .card-stripe-green{background:var(--green)}
  .card-stripe-red{background:var(--red)}
  .card-stripe-blue{background:var(--blue)}
  .card-stripe-grey{background:var(--grey)}
  .card-content{display:grid;gap:6px;padding:clamp(12px,2vw,16px);padding-right:clamp(10px,1.8vw,14px)}
  .card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .card-category{display:grid;gap:2px}
  .card-category-title{color:var(--ink);font-weight:800;font-size:clamp(14px,1.8vw,16px)}
  .card-category-desc{color:var(--muted);font-size:clamp(12px,1.6vw,13px)}
  .title-text{color:var(--ink);font-weight:800;letter-spacing:.2px;font-size:clamp(15px,1.9vw,17px);margin:0}
  .description{color:var(--text);opacity:.9;font-size:clamp(14px,1.8vw,16px);margin:0}
  .meta{color:var(--muted);font-size:clamp(13px,1.6vw,15px)}
  .chev{opacity:.9;align-self:center;padding:0 clamp(12px,2vw,16px);display:flex;align-items:center;justify-content:center}
  .badge{display:inline-flex;align-items:center;gap:6px;font-size:clamp(12px,1.5vw,13px);font-weight:700;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.08);color:var(--ink);border:1px solid var(--line)}
  .timestamp{margin-left:auto;color:var(--muted);font-size:clamp(12px,1.5vw,13px)}

  .empty{padding:32px;border:2px dashed var(--line);border-radius:12px;text-align:center;color:var(--muted);background:var(--card);display:grid;gap:12px;justify-items:center}
  .error{padding:32px;border:2px dashed var(--red);border-radius:12px;text-align:center;color:var(--ink);background:rgba(234,124,118,.1);display:grid;gap:12px;justify-items:center}
  .error p{margin:0;font-weight:700}
  .empty-refresh{appearance:none;border:2px solid var(--line);background:var(--btn);color:var(--ink);padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer}
  .empty-refresh:hover{background:var(--btn-hover)}
  .empty-refresh:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
  .loading{padding:32px;border:2px solid var(--line);border-radius:12px;text-align:center;font-weight:700;color:var(--ink);background:var(--card)}
  .inline-alert{display:flex;align-items:center;gap:12px;padding:14px 18px;border-radius:12px;background:rgba(231,173,106,.14);border:2px solid var(--amber);color:var(--ink);font-weight:600}
  .inline-alert__message{flex:1;min-width:0}
  .inline-alert__actions{display:flex;gap:10px}
  .inline-alert button{appearance:none;border:2px solid var(--line);background:var(--btn);color:var(--ink);padding:8px 14px;border-radius:999px;font-weight:700;cursor:pointer;min-height:38px}
  .inline-alert button:hover{background:var(--btn-hover)}
  .inline-empty{padding:24px;border:2px dashed var(--line);border-radius:12px;text-align:center;color:var(--muted);background:var(--card);font-weight:600}

  .detail-view{display:none;grid-template-columns:1fr;gap:16px}
  .detail-view[aria-hidden="false"]{display:grid}
  .detail{background:var(--detail);border:2px solid var(--line);border-radius:12px;padding:clamp(14px,2.2vw,20px)}
  .detail-head{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
  .crumbs{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:clamp(13px,1.6vw,15px)}
  .crumbs strong{color:var(--ink)}
  .crumbs button{background:none;border:none;color:var(--ink);font-weight:700;cursor:pointer;padding:0;font-size:inherit}
  .crumbs button:hover{text-decoration:underline}
  .detail .label{color:var(--muted);font-size:clamp(13px,1.5vw,15px);margin-bottom:6px}
  .detail h2{margin:0 0 8px 0;font-size:clamp(18px,2.2vw,22px);color:var(--ink)}
  .detail p{margin:0 0 12px 0}
  .detail .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{appearance:none;border:2px solid var(--line);background:var(--btn);color:var(--text);
    padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;min-height:44px}
  .btn:hover{background:var(--btn-hover)}
  .detail-tag{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;font-weight:700;font-size:clamp(12px,1.5vw,13px);background:var(--card);border:1px solid var(--line);color:var(--ink)}
  .detail-tag::before{content:'';width:10px;height:10px;border-radius:50%}
  .detail-tag.green::before{background:var(--green)}
  .detail-tag.red::before{background:var(--red)}
  .detail-tag.blue::before{background:var(--blue)}
  .detail-tag.grey::before{background:var(--grey)}

  @media (max-width:720px){
    .controls{flex-direction:column;align-items:stretch}
    .search{width:100%}
    .search input{width:100%}
  }
</style>
</head>
<body>
  <main class="frame">
    <div id="globalMenu"></div>
    <section class="inner">
      <header class="section-banner">
        <h1 class="section-title">AI review</h1>
        <p class="section-subtitle">Track automation readiness by color-coded signal.</p>
      </header>

      <div class="controls" aria-label="AI review filters">
        <div class="filters" role="toolbar" aria-label="Category filters">
          <button class="pill" type="button" data-filter="all" aria-pressed="true">All <span class="pill-count" data-count="all">0</span></button>
          <button class="pill pill-green" type="button" data-filter="green" aria-pressed="false">Green <span class="pill-count" data-count="green">0</span></button>
          <button class="pill pill-blue" type="button" data-filter="blue" aria-pressed="false">Blue <span class="pill-count" data-count="blue">0</span></button>
          <button class="pill pill-red" type="button" data-filter="red" aria-pressed="false">Red <span class="pill-count" data-count="red">0</span></button>
          <button class="pill pill-grey" type="button" data-filter="grey" aria-pressed="false">Grey <span class="pill-count" data-count="grey">0</span></button>
        </div>
        <label class="search">
          <span class="sr-only" id="searchLabel">Search keywords</span>
          <input id="searchInput" type="search" placeholder="Search subjects or senders" aria-labelledby="searchLabel">
        </label>
      </div>

      <div id="reviewContent">
        <div class="inline-alert" id="degradedBanner" hidden role="status" aria-live="polite">
          <span class="inline-alert__message" id="degradedMessage">Showing cached results while we reconnect…</span>
          <div class="inline-alert__actions">
            <button type="button" id="degradedRetry">Retry</button>
          </div>
        </div>
        <div class="loading" id="loadingState" role="status">Loading review signals…</div>
        <div class="stack" id="groupContainer" hidden></div>
        <div class="inline-empty" id="noResultsNotice" hidden role="status" aria-live="polite">No review items match your filters.</div>
        <div class="empty" id="emptyState" hidden role="region" aria-label="AI review empty state" tabindex="-1">
          <p>No items to review yet.</p>
          <button class="empty-refresh" type="button" id="emptyRefresh">Refresh now</button>
        </div>
        <div class="error" id="errorState" hidden role="region" aria-label="AI review error state" tabindex="-1">
          <p>We hit a snag loading review signals.</p>
          <button class="empty-refresh" type="button" id="errorRetry">Try again</button>
        </div>
      </div>

      <div class="detail-view" id="detailView" aria-hidden="true">
        <div class="detail-head">
          <div class="crumbs">
            <button type="button" id="detailBack">AI review</button>
            <span>/</span>
            <strong id="detailCrumb">Details</strong>
          </div>
          <button class="btn" type="button" id="detailBackBtn">Back to list</button>
        </div>
        <article class="detail" aria-live="polite">
          <div class="label">Message</div>
          <span class="detail-tag" id="detailTag">Grey • Metadata pending</span>
          <h2 id="detailTitle">Select an item</h2>
          <p id="detailMeta">Pick a review item to see its automation readiness.</p>
          <p id="detailSynopsis"></p>
          <p class="meta" id="detailAiMeta"></p>
          <p class="meta" id="detailAiRequirements"></p>
          <p id="detailBody"></p>
          <div class="actions">
            <button class="btn" id="detailOpen">Open in inbox</button>
            <button class="btn" id="detailApprove">Approve automation</button>
            <button class="btn" id="detailArchive">Archive</button>
            <button class="btn" id="detailReassess">Reassess AI metadata</button>
          </div>
        </article>
      </div>
    </section>
  </main>

  <footer id="appFooter" class="app-footer" role="contentinfo"></footer>
<script src="footer-overscroll.js"></script>
<script src="refresh-utils.js"></script>
<script src="ai-classifier.js"></script>
<script src="ai-category-constants.js"></script>
<script>
  const DB_KEY='faux-emails', AUTH_KEY='faux-auth';
  const LOAD_TIMEOUT_MS=10000;

  const telemetry=(window.telemetry && typeof window.telemetry.log==='function')
    ? window.telemetry
    : {
        log(event,payload){
          if(window && window.console && typeof window.console.log==='function'){
            window.console.log(`[telemetry] ${event}`, payload);
          }
        }
      };

  function svgPentagon(){ return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l9 6-3.4 10.5H6.4L3 8l9-6z"/></svg>'; }
  function escapeHtml(str=''){ const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}; return String(str).replace(/[&<>"']/g,ch=>map[ch]); }
  function setTheme(theme){
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('notif-theme', theme);
    syncThemeControls();
  }
  function syncThemeControls(){
    const currentTheme=document.documentElement.getAttribute('data-theme')||'dark';
    const label=document.getElementById('themeLabel');
    if(label){ label.textContent=currentTheme==='light'?'Light':'Dark'; }
    const toggle=document.getElementById('themeToggle');
    if(toggle){
      const isLight=currentTheme==='light';
      toggle.setAttribute('aria-pressed', isLight?'true':'false');
      toggle.setAttribute('aria-label', isLight?'Switch to dark theme':'Switch to light theme');
    }
  }
  (function initTheme(){
    const stored=localStorage.getItem('notif-theme');
    if(stored){ setTheme(stored); }
    else {
      const prefersLight=window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      setTheme(prefersLight?'light':'dark');
    }
  })();

  function seedDB(){
    if(localStorage.getItem(DB_KEY)) return;
    const now=Date.now();
    const emails=[
      {id:'e1', from:'billing@tenant.io', subject:'Payment overdue: INV-1043', body:'Please process the pending invoice within 3 days to avoid late fees. Manual review advised before charging the account.', status:'urgent', received: now-3600*1000*6},
      {id:'e2', from:'noreply@mailer.ai', subject:'Draft reply prepared', body:'AI drafted a response to tenant question about parking. Review and approve to send automatically.', status:'draft', received: now-3600*1000*12},
      {id:'e3', from:'support@locks.example', subject:'Smartlock offline – needs context', body:'Device reported intermittent connectivity and needs context about the environment before attempting a reset.', status:'needs_context', received: now-3600*1000*22},
      {id:'e4', from:'updates@crm.example', subject:'Profile note: tenant has a dog', body:'FYI: Add pet note to the profile. No action required yet.', status:'info', received: now-3600*1000*30},
      {id:'e5', from:'system@ops.example', subject:'Unhandled case detected', body:'AI could not determine a safe action. Manual review required to resolve the unhandled workflow.', status:'manual', received: now-3600*1000*40}
    ];
    const assessed = window.AIClassifier ? window.AIClassifier.ingest(emails, new Date(now)) : emails;
    localStorage.setItem(DB_KEY, JSON.stringify(assessed));
  }

  function rawEmails(){
    try{
      return JSON.parse(localStorage.getItem(DB_KEY))||[];
    }catch{
      return [];
    }
  }

  function persistEmails(emails){
    localStorage.setItem(DB_KEY, JSON.stringify(emails));
  }

  function getEmails(){
    const emails = rawEmails();
    let mutated = false;
    if(window.AIClassifier){
      emails.forEach(email => {
        const version = email.ai && email.ai.assessor_version;
        if(!email.ai){
          window.AIClassifier.applyAssessment(email);
          mutated = true;
        } else if(version === 'manual-override'){
          email.aiCategory = email.ai.category;
          email.aiSynopsis = email.ai.notes;
        } else if(version !== window.AIClassifier.VERSION){
          window.AIClassifier.applyAssessment(email);
          mutated = true;
        } else {
          email.aiCategory = email.ai.category;
          email.aiSynopsis = email.ai.notes;
        }
      });
    }
    if(mutated){
      persistEmails(emails);
    }
    return emails;
  }

  function reassessEmail(id){
    if(!window.AIClassifier) return null;
    const emails = rawEmails();
    const updated = window.AIClassifier.reassess(emails, id, new Date());
    if(updated){
      persistEmails(emails);
    }
    return updated;
  }

  window.aiAssessorAPI = {
    reassessEmail
  };

  seedDB();

  function isAuthed(){ return !!localStorage.getItem(AUTH_KEY); }
  function getCurrentUser(){ return localStorage.getItem(AUTH_KEY) || ''; }

  function globalMenuHtml({authed=false}={}){
    const currentPage=(window.location.pathname.split('/').pop()||'ai-review.html').toLowerCase();
    const navLinks=authed
      ? [
          {href:'index.html',label:'Activity'},
          {href:'ai-review.html',label:'AI review'},
          {href:'admin.html',label:'Admin'}
        ].map(({href,label})=>{
          const isCurrent=currentPage===href.toLowerCase();
          const aria=isCurrent?' aria-current="page"':'';
          return `<a class="link" href="${href}"${aria}>${label}</a>`;
        }).join('')
      : '';
    const nav=authed?`<nav class="global-nav" aria-label="Primary navigation">${navLinks}</nav>`:'';
    return `
      <div class="global-menu">
        <div class="global-title">${svgPentagon()} Operations Console</div>
        ${nav}
      </div>`;
  }

  function globalFooterHtml({authed=false,user=''}={}){
    const displayName=authed && user?escapeHtml(user):'—';
    const themeLabel=document.documentElement.getAttribute('data-theme')==='light'?'Light':'Dark';
    const logoutAttrs=authed?'':' disabled aria-disabled="true"';
    return `
      <div class="footer-meta" aria-live="polite">
        <span>Signed in as</span>
        <strong>${displayName}</strong>
      </div>
      <div class="footer-actions">
        <button class="footer-button" type="button" id="logoutBtn"${logoutAttrs}>Logout</button>
        <div class="footer-theme">
          <span class="footer-theme-label" id="themeLabel">${themeLabel}</span>
          <button class="toggle" type="button" id="themeToggle" aria-pressed="false">
            <span class="knob"></span>
          </button>
        </div>
      </div>`;
  }

  function renderFooter({authed=false,user='',onLogout}={}){
    const host=document.getElementById('appFooter');
    if(!host) return;
    host.innerHTML=globalFooterHtml({authed,user});
    attachGlobalFooterHandlers(onLogout);
  }

  function handleLogout(){
    localStorage.removeItem(AUTH_KEY);
    window.location.replace('index.html');
  }

  function attachGlobalFooterHandlers(onLogout){
    syncThemeControls();
    const toggle=document.getElementById('themeToggle');
    if(toggle){ toggle.addEventListener('click',()=>{
      const current=document.documentElement.getAttribute('data-theme')||'dark';
      setTheme(current==='dark'?'light':'dark');
    }); }
    const logout=document.getElementById('logoutBtn');
    if(logout && !logout.disabled){
      logout.addEventListener('click',()=>{
        if(typeof onLogout==='function'){
          onLogout();
        } else {
          handleLogout();
        }
      });
    }
  }

  const authed=isAuthed();
  const currentUser=authed?getCurrentUser():'';
  const globalMenuHost=document.getElementById('globalMenu');
  if(globalMenuHost){ globalMenuHost.innerHTML=globalMenuHtml({authed}); }
  renderFooter({authed,user:currentUser,onLogout:authed?handleLogout:undefined});
  if(!authed){
    window.location.replace('index.html');
  } else {

  const AICategory = window.AICategory || {
    AI_CATEGORY_COPY: {},
    normalizeCategory: () => 'grey',
    getCategoryPresentation: () => ({ key: 'grey', title: 'Unassessed', description: 'Awaiting AI review.', stripeClass: 'card-stripe-grey', ariaLabel: 'Unassessed' })
  };

  const CATEGORY_INFO={
    green:{detail:'Automation can proceed with high confidence.'},
    blue:{detail:'More context is required before automation can resume.'},
    red:{detail:'Risk detected — manual intervention recommended.'},
    grey:{detail:'AI has not provided metadata for this item yet.'}
  };

  function formatList(items, fallback='None'){
    return Array.isArray(items) && items.length ? items.join(', ') : fallback;
  }

  function formatConfidence(ai){
    return typeof ai.confidence === 'number' ? `${Math.round(ai.confidence * 100)}%` : null;
  }

  const VIEW_STATES={
    IDLE:'idle',
    LOADING:'loading',
    SUCCESS:'success',
    EMPTY:'empty',
    ERROR:'error',
    DEGRADED:'degraded'
  };

  const state={
    items:[],
    cachedItems:[],
    filter:'all',
    search:'',
    view:VIEW_STATES.IDLE,
    detailId:null,
    errorMessage:'',
    lastView:VIEW_STATES.IDLE,
    pendingLoad:false
  };

  function logInfoEvent(event,payload){
    try {
      if(window && window.console && typeof window.console.info==='function'){
        window.console.info('[ai_review]', event, payload);
      }
    } catch (_) {
      /* noop */
    }
  }

  let lastStateLog='';
  let lastBannerLog='';
  let lastConflictLog='';

  function logAiReviewState(){
    const payload={
      view:state.view,
      lastView:state.lastView,
      itemCount:state.items.length,
      cachedCount:state.cachedItems.length,
      filter:state.filter,
      search:state.search,
      detailOpen:!!state.detailId,
      pendingLoad:state.pendingLoad
    };
    const fingerprint=JSON.stringify(payload);
    if(fingerprint===lastStateLog) return;
    lastStateLog=fingerprint;
    logInfoEvent('ai_review_state', payload);
  }

  function logBannerDecision(payload){
    const fingerprint=JSON.stringify(payload);
    if(fingerprint===lastBannerLog) return;
    lastBannerLog=fingerprint;
    logInfoEvent('banner_decision', payload);
  }

  function logBannerConflict(active){
    const payload={
      view:state.view,
      lastView:state.lastView,
      itemCount:state.items.length,
      cachedCount:state.cachedItems.length,
      filter:state.filter,
      search:state.search,
      active
    };
    const fingerprint=JSON.stringify(payload);
    if(fingerprint===lastConflictLog) return;
    lastConflictLog=fingerprint;
    logInfoEvent('banner_conflict', payload);
  }

  const REFRESH_INTERVAL = window.AutoRefresh ? window.AutoRefresh.DEFAULT_INTERVAL : 15000;
  let autoRefreshController = null;
  let activeLoadTimer=null;

  const groupContainer=document.getElementById('groupContainer');
  const loadingState=document.getElementById('loadingState');
  const emptyState=document.getElementById('emptyState');
  const errorState=document.getElementById('errorState');
  const reviewContent=document.getElementById('reviewContent');
  const filterButtons=Array.from(document.querySelectorAll('[data-filter]'));
  const searchInput=document.getElementById('searchInput');
  const detailView=document.getElementById('detailView');
  const detailTitle=document.getElementById('detailTitle');
  const detailMeta=document.getElementById('detailMeta');
  const detailBody=document.getElementById('detailBody');
  const detailSynopsis=document.getElementById('detailSynopsis');
  const detailTag=document.getElementById('detailTag');
  const detailCrumb=document.getElementById('detailCrumb');
  const detailAiMeta=document.getElementById('detailAiMeta');
  const detailAiRequirements=document.getElementById('detailAiRequirements');
  const detailReassess=document.getElementById('detailReassess');
  const emptyRefresh=document.getElementById('emptyRefresh');
  const errorRetry=document.getElementById('errorRetry');
  const degradedBanner=document.getElementById('degradedBanner');
  const degradedMessage=document.getElementById('degradedMessage');
  const degradedRetry=document.getElementById('degradedRetry');
  const noResultsNotice=document.getElementById('noResultsNotice');
  const errorMessage=errorState?errorState.querySelector('p'):null;
  const DEFAULT_ERROR_MESSAGE='We hit a snag loading review signals.';

  function normalizeItems(items){
    return Array.isArray(items) ? items.slice().sort((a,b)=>b.received-a.received) : [];
  }

  function fetchLatestItems(){
    const loader=(window.aiReviewDataSource && typeof window.aiReviewDataSource.fetch==='function')
      ? window.aiReviewDataSource.fetch
      : ()=>getEmails();
    return Promise.resolve().then(()=>loader());
  }

  state.cachedItems=normalizeItems(getEmails());
  state.items=state.cachedItems.slice();

  function getCategory(item){
    const raw = item && item.ai ? item.ai.category : null;
    return AICategory.normalizeCategory(raw || item.aiCategory);
  }

  function formatTime(ts){ return new Date(ts).toLocaleString(); }

  function matchesSearch(item, term){
    if(!term) return true;
    const ai=item.ai||{};
    const hay=[
      item.subject,
      item.from,
      item.body,
      item.status,
      item.aiSynopsis,
      ai.notes,
      ...(ai.blockers||[]),
      ...(ai.required_permissions||[]),
      ...(ai.required_context||[])
    ].map(v=>String(v||'').toLowerCase()).join(' ');
    return hay.includes(term.toLowerCase());
  }

  function updateCounts(items){
    const counts={green:0,blue:0,red:0,grey:0};
    items.forEach(item=>{ counts[getCategory(item)]++; });
    filterButtons.forEach(btn=>{
      const key=btn.getAttribute('data-filter');
      const badge=document.querySelector(`[data-count="${key}"]`);
      if(!badge) return;
      if(key==='all'){ badge.textContent=items.length; }
      else { badge.textContent=counts[key]||0; }
    });
  }

  function renderList(){
    const filtered=state.items.filter(item=>{
      const category=getCategory(item);
      if(state.filter!=='all' && category!==state.filter) return false;
      return matchesSearch(item, state.search);
    });

    if(!filtered.length){
      groupContainer.innerHTML='';
      return false;
    }

    const groups=['green','blue','red','grey'];
    const markup=groups
      .map(groupKey=>{
        const groupItems=filtered.filter(item=>getCategory(item)===groupKey);
        if(!groupItems.length) return '';
        const presentation=AICategory.getCategoryPresentation(groupKey);
        const cards=groupItems.map(item=>{
          const ai=item.ai||{};
          const synopsis=ai.notes || item.aiSynopsis || 'Metadata pending for this message.';
          const confidence=formatConfidence(ai);
          const metaParts=[`From ${escapeHtml(item.from)}`,`Status: ${escapeHtml(item.status)}`];
          if(confidence){ metaParts.push(`Confidence: ${confidence}`); }
          if(item.ai && item.ai.assessor_version === 'manual-override'){
            metaParts.push('Manual override');
          }
          const itemCategory=getCategory(item);
          const stripe=AICategory.getCategoryPresentation(itemCategory);
          const stripeClass=stripe.stripeClass || `card-stripe-${itemCategory}`;
          return `<button class="card" data-id="${item.id}">
            <span class="card-stripe ${stripeClass}" aria-label="${escapeHtml(stripe.title)}"></span>
            <div class="card-content">
              <div class="card-header">
                <div class="card-category">
                  <span class="card-category-title">${escapeHtml(stripe.title)}</span>
                  <span class="card-category-desc">${escapeHtml(stripe.description)}</span>
                </div>
                <span class="timestamp">${formatTime(item.received)}</span>
              </div>
              <div class="title-text">${escapeHtml(item.subject)}</div>
              <p class="description">${escapeHtml(synopsis)}</p>
              <div class="meta">${metaParts.join(' • ')}</div>
            </div>
            <span class="chev">${'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 6l6 6-6 6"/></svg>'}</span>
          </button>`;
        }).join('');
        return `<div class="group">
          <div class="group-title">${escapeHtml(presentation.title)} <span class="group-count">${groupItems.length} items</span></div>
          <div class="group-cards">${cards}</div>
        </div>`;
      }).join('');
    groupContainer.innerHTML=markup;
    groupContainer.querySelectorAll('.card[data-id]').forEach(btn=>{
      btn.addEventListener('click',()=>openDetail(btn.getAttribute('data-id')));
    });
    return true;
  }

  function render(){
    const view=state.view;
    const shouldRenderList=view===VIEW_STATES.SUCCESS || view===VIEW_STATES.DEGRADED;
    let hasVisible=false;

    logAiReviewState();

    if(view!==VIEW_STATES.LOADING){
      updateCounts(state.items);
    }

    if(shouldRenderList){
      hasVisible=renderList();
    } else {
      groupContainer.innerHTML='';
    }

    const showLoading=view===VIEW_STATES.LOADING;
    const showEmpty=view===VIEW_STATES.EMPTY;
    const showError=view===VIEW_STATES.ERROR;
    const showDegraded=view===VIEW_STATES.DEGRADED && hasVisible;
    const showNoResults=shouldRenderList && state.items.length>0 && !hasVisible;

    const bannerPayload={
      view,
      lastView:state.lastView,
      itemCount:state.items.length,
      cachedCount:state.cachedItems.length,
      filter:state.filter,
      search:state.search,
      hasVisible,
      banners:{
        loading:showLoading,
        degraded:showDegraded,
        empty:showEmpty,
        error:showError,
        noResults:showNoResults
      }
    };
    bannerPayload.active=Object.entries(bannerPayload.banners)
      .filter(([,value])=>!!value)
      .map(([key])=>key);
    logBannerDecision(bannerPayload);

    const conflicting=bannerPayload.active.filter(key=>key==='degraded'||key==='empty'||key==='error');
    if(conflicting.length>1){
      logBannerConflict(conflicting);
    } else if(conflicting.length===0){
      lastConflictLog='';
    }

    if(loadingState){
      loadingState.hidden=!showLoading;
    }

    if(groupContainer){
      groupContainer.hidden=!shouldRenderList || !hasVisible;
    }

    if(noResultsNotice){
      noResultsNotice.hidden=!showNoResults;
    }

    if(emptyState){
      emptyState.hidden=!showEmpty;
      if(showEmpty && state.lastView!==VIEW_STATES.EMPTY && typeof emptyState.focus==='function'){
        emptyState.focus();
      }
    }

    if(errorState){
      errorState.hidden=!showError;
      if(showError && errorMessage){
        errorMessage.textContent=state.errorMessage || DEFAULT_ERROR_MESSAGE;
      }
      if(showError && state.lastView!==VIEW_STATES.ERROR && typeof errorState.focus==='function'){
        errorState.focus();
      }
    }

    if(degradedBanner){
      degradedBanner.hidden=!showDegraded;
      if(showDegraded && degradedMessage){
        degradedMessage.textContent=state.errorMessage || 'Showing cached results while we reconnect…';
      }
    }

    if(view===VIEW_STATES.ERROR || view===VIEW_STATES.EMPTY){
      closeDetail();
    }

    state.lastView=view;
  }

  function setItems(items,{cache=false}={}){
    state.items=normalizeItems(items);
    if(cache){
      state.cachedItems=state.items.slice();
    }
  }

  function renderDetail(email,{scrollIntoView=true}={}){
    if(!email){
      closeDetail();
      return;
    }
    const category=getCategory(email);
    const info=CATEGORY_INFO[category] || CATEGORY_INFO.grey;
    const presentation=AICategory.getCategoryPresentation(category);
    const ai=email.ai||{};
    const confidence=formatConfidence(ai) || '–';
    const assessed=ai.assessed_at ? new Date(ai.assessed_at).toLocaleString() : '–';
    const assessor=ai.assessor_version || 'unknown';
    const blockers=formatList(ai.blockers);
    const permissions=formatList(ai.required_permissions);
    const context=formatList(ai.required_context);
    detailTitle.textContent=email.subject;
    detailMeta.innerHTML=`<strong>From:</strong> ${escapeHtml(email.from)} • <strong>Received:</strong> ${formatTime(email.received)} • <strong>Status:</strong> ${escapeHtml(email.status)} • <strong>AI:</strong> ${escapeHtml(presentation.title)} (${category.toUpperCase()} • ${confidence} confidence)`;
    detailBody.textContent=email.body;
    detailSynopsis.textContent=ai.notes || email.aiSynopsis || 'Metadata pending for this message.';
    const assessorLabel=escapeHtml(assessor);
    const overrideBanner=assessor==='manual-override' ? ' • Manual override active' : '';
    detailAiMeta.textContent=`Assessed ${assessed} • Assessor: ${assessorLabel} • Confidence: ${confidence}${overrideBanner}`;
    detailAiRequirements.textContent=`Blockers: ${escapeHtml(blockers)} • Permissions: ${escapeHtml(permissions)} • Context: ${escapeHtml(context)}`;
    detailTag.textContent=`${presentation.title} • ${info.detail}`;
    detailTag.className=`detail-tag ${category}`;
    detailCrumb.textContent=email.subject;
    state.detailId=email.id;
    reviewContent.hidden=true;
    detailView.setAttribute('aria-hidden','false');
    if(scrollIntoView){
      detailView.scrollIntoView({behavior:'smooth',block:'start'});
    }
  }

  function load(){
    if(state.pendingLoad) return;
    state.pendingLoad=true;
    state.view=VIEW_STATES.LOADING;
    state.errorMessage='';
    render();
    const start=typeof performance!=='undefined' && performance.now ? performance.now() : Date.now();
    if(activeLoadTimer){
      clearTimeout(activeLoadTimer);
      activeLoadTimer=null;
    }
    let settled=false;
    const finalize=(status,details={})=>{
      if(settled) return;
      settled=true;
      if(activeLoadTimer){
        clearTimeout(activeLoadTimer);
        activeLoadTimer=null;
      }
      state.pendingLoad=false;
      const end=typeof performance!=='undefined' && performance.now ? performance.now() : Date.now();
      const duration=Math.round(end-start);
      try {
        telemetry.log('ai_review_load',{status,durationMs:duration,...details});
      } catch (err) {
        /* ignore telemetry errors */
      }
    };
    const handleSuccess=items=>{
      if(settled) return;
      setItems(Array.isArray(items)?items:[],{cache:true});
      const nextView=state.items.length?VIEW_STATES.SUCCESS:VIEW_STATES.EMPTY;
      state.view=nextView;
      state.errorMessage='';
      finalize(nextView,{itemCount:state.items.length});
      render();
      ensureAutoRefresh();
    };
    const handleFailure=message=>{
      if(settled) return;
      const errorMsg=message || DEFAULT_ERROR_MESSAGE;
      state.errorMessage=errorMsg;
      if(state.cachedItems.length){
        state.items=state.cachedItems.slice();
        state.view=VIEW_STATES.DEGRADED;
      } else {
        state.items=[];
        state.view=VIEW_STATES.ERROR;
      }
      finalize(state.view,{message:errorMsg,itemCount:state.items.length});
      render();
      ensureAutoRefresh();
    };
    fetchLatestItems()
      .then(handleSuccess)
      .catch(err=>handleFailure(err && err.message ? err.message : DEFAULT_ERROR_MESSAGE));
    activeLoadTimer=setTimeout(()=>{
      if(settled) return;
      handleFailure(DEFAULT_ERROR_MESSAGE);
    },LOAD_TIMEOUT_MS);
  }

  function syncAndRender({skipScroll=false}={}){
    try {
      const data=getEmails();
      setItems(data,{cache:true});
      if(state.view!==VIEW_STATES.DEGRADED){
        state.view=state.items.length?VIEW_STATES.SUCCESS:VIEW_STATES.EMPTY;
        state.errorMessage='';
      }
    } catch (err){
      const message=err && err.message ? err.message : DEFAULT_ERROR_MESSAGE;
      state.errorMessage=message;
      if(state.cachedItems.length){
        state.items=state.cachedItems.slice();
        state.view=VIEW_STATES.DEGRADED;
      } else {
        state.items=[];
        state.view=VIEW_STATES.ERROR;
      }
    }
    render();
    if(state.view===VIEW_STATES.ERROR){
      return;
    }
    if(state.detailId){
      const email=state.items.find(item=>item.id===state.detailId);
      if(email){
        renderDetail(email,{scrollIntoView:!skipScroll});
      } else {
        closeDetail();
      }
    }
  }

  function ensureAutoRefresh(){
    if(!window.AutoRefresh || autoRefreshController) return;
    autoRefreshController=window.AutoRefresh.createAutoRefresh({
      refresh:()=>load(),
      intervalMs:REFRESH_INTERVAL,
      immediate:false,
      autoStart:false
    });
    autoRefreshController.start();
  }

  function setFilter(value){
    state.filter=value;
    filterButtons.forEach(btn=>{
      const pressed=btn.getAttribute('data-filter')===value;
      btn.setAttribute('aria-pressed', pressed?'true':'false');
    });
    render();
  }

  filterButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const value=btn.getAttribute('data-filter');
      setFilter(value);
    });
  });

  searchInput.addEventListener('input',()=>{
    state.search=searchInput.value.trim().toLowerCase();
    render();
  });

  function openDetail(id, options={}){
    const email=state.items.find(item=>item.id===id);
    if(!email){
      closeDetail();
      return;
    }
    renderDetail(email,options);
  }

  function closeDetail(){
    reviewContent.hidden=false;
    detailView.setAttribute('aria-hidden','true');
    state.detailId=null;
  }

  document.getElementById('detailBack').addEventListener('click',closeDetail);
  document.getElementById('detailBackBtn').addEventListener('click',closeDetail);

  if(emptyRefresh){
    emptyRefresh.addEventListener('click',()=>load());
  }
  if(errorRetry){
    errorRetry.addEventListener('click',()=>load());
  }
  if(degradedRetry){
    degradedRetry.addEventListener('click',()=>load());
  }

  if(detailReassess){
    detailReassess.addEventListener('click',()=>{
      if(!state.detailId) return;
      const updated=reassessEmail(state.detailId);
      if(updated){
        syncAndRender({skipScroll:true});
      }
    });
  }

  load();
  }
</script>
</body>
</html>
