<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mail Integration Admin</title>
<style>
  :root {
    --radius:14px;
    --gap:12px;
    --focus:#6ea4e8;
    --page-pad:clamp(16px,3vw,28px);
    --frame-gap:clamp(12px,2.2vw,18px);
    --shell-header-height:77px;
    --shell-page-top-gap:18px;
    --shell-header-height-mobile:69.5px;
    --shell-page-top-gap-mobile:12px;
    --shell-header-pad-inline:clamp(12px,2.2vw,16px);
    --shell-logo-size:48px;
    --shell-logo-size-mobile:32px;
    --panel-pad:clamp(16px,2vw,20px);
    --panel-pad-mobile:clamp(12px,4vw,16px);
    --footer-safe-area:env(safe-area-inset-bottom);
    --btn-height-sm:34px;
    --btn-height-md:38px;
    --btn-height-lg:42px;
    --btn-height-max:44px;
    --btn-height-sm-mobile:32px;
    --btn-height-md-mobile:34px;
    --btn-height-lg-mobile:36px;
    --btn-height-max-mobile:38px;
  }
  @media (max-width:720px){
    :root{
      --shell-header-height:var(--shell-header-height-mobile);
      --shell-page-top-gap:var(--shell-page-top-gap-mobile);
      --shell-logo-size:var(--shell-logo-size-mobile);
      --panel-pad:var(--panel-pad-mobile);
      --btn-height-sm:var(--btn-height-sm-mobile);
      --btn-height-md:var(--btn-height-md-mobile);
      --btn-height-lg:var(--btn-height-lg-mobile);
      --btn-height-max:var(--btn-height-max-mobile);
    }
  }
  :root, html[data-theme="dark"] {
    --bg:#141b26; --panel:#1a2330; --ink:#f4f7fb; --text:#d7dee7; --muted:#a5b3c5;
    --line:#364353; --card:#1d2735; --card-hover:#243041; --banner:#1b2534;
    --detail:#202b3b; --btn:#232f3f; --btn-hover:#2a3749; --accent-muted:#93a5bb;
    --red:#ea7c76; --green:#5ec49d; --blue:#78aeea; --amber:#e7ad6a; --crimson:#ed8a7d;
    --shadow:0 6px 24px rgba(6,11,20,.32);
  }
  html[data-theme="light"] {
    --bg:#f2f4f7; --panel:#ffffff; --ink:#1e2936; --text:#2e3a4c; --muted:#647184;
    --line:#d0d7e2; --card:#ffffff; --card-hover:#f5f7fa; --banner:#f1f3f7;
    --detail:#f7f9fc; --btn:#eceff5; --btn-hover:#e1e5ed; --accent-muted:#7b889b;
    --red:#c6615b; --green:#3c8f6b; --blue:#3a7bd5; --amber:#c38b44; --crimson:#c46f63;
    --shadow:0 4px 18px rgba(15,23,42,.08); --focus:#3a7bd5;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);
    font: clamp(15px,1.6vw,17px)/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    min-height:100vh;display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;
    gap:var(--page-pad);padding:var(--page-pad);
    overflow-x:hidden;transition:background .2s,color .2s}
  .frame{margin:0 auto;width:min(1100px,100%);max-width:100%;background:var(--panel);border:2px solid var(--line);border-radius:18px;padding:clamp(12px,2.2vw,18px);box-shadow:var(--shadow);
    display:grid;gap:0;flex:1 0 auto;min-height:0}
  .frame > *{margin-block:0}
  .frame > :first-child{margin-block-start:0}
  .frame > :first-child + *{margin-block-start:0}
  #globalShell{display:contents}
  .global-shell{display:contents}
  .app-header{background:var(--banner);border:2px solid var(--line);border-radius:12px;
    padding:0 var(--shell-header-pad-inline);display:flex;align-items:center;width:100%;box-sizing:border-box;
    gap:clamp(12px,2vw,18px);height:var(--shell-header-height);min-height:0;position:relative}
  .app-logo{width:var(--shell-logo-size);height:var(--shell-logo-size);flex:0 0 auto;
    display:flex;align-items:center;justify-content:center;color:var(--ink)}
  .app-logo svg{width:100%;height:100%;display:block}
  .app-title{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);text-align:center;
    font-weight:800;letter-spacing:.2px;font-size:clamp(18px,2.2vw,22px);color:var(--ink);
    white-space:nowrap;pointer-events:none;line-height:1}
  .primary-menu{gap:10px;justify-content:flex-end;overflow-x:auto;flex-wrap:nowrap;margin:0;margin-left:auto;
    scrollbar-width:none;display:flex;align-items:center;flex:0 1 auto;padding:0}
  .primary-menu[aria-hidden="true"]{justify-content:flex-end}
  .primary-menu::-webkit-scrollbar{display:none}
  .primary-menu__placeholder{opacity:.4;font-weight:600;font-size:14px}
  .page-sections{display:grid;gap:var(--frame-gap);margin:var(--shell-page-top-gap) 0 0;padding:0;position:relative;min-height:0}
  .page-sections > *{margin-block:0}
  .page-sections > :first-child{margin-block-start:0}
  .inner{display:grid;gap:16px;background:var(--panel);border:2px solid var(--line);border-radius:14px;padding:var(--panel-pad)}

  .btn,
  .btn-sm,
  .link,
  .footer-button{box-sizing:border-box;display:inline-flex;align-items:center;justify-content:center;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;max-width:100%;min-height:0;max-height:var(--btn-height-max);gap:6px}
  .link{color:var(--ink);text-decoration:none;font-weight:700;padding:0 clamp(12px,2vw,16px);border-radius:10px;border:2px solid var(--line);background:var(--btn);flex:0 0 auto;height:var(--btn-height-md)}
  .link:hover{background:var(--btn-hover)}
  .link[aria-current="page"]{background:var(--ink);color:var(--bg);border-color:var(--ink)}
  .toggle{width:54px;height:30px;border-radius:100px;border:2px solid var(--line);background:var(--btn);position:relative;cursor:pointer}
  .toggle:hover{background:var(--btn-hover)}
  .toggle:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
  .knob{width:22px;height:22px;border-radius:50%;background:var(--ink);position:absolute;top:50%;transform:translateY(-50%);left:4px;transition:left .2s}
  html[data-theme="light"] .knob{left:28px}
  .app-footer{position:sticky;bottom:0;background:var(--banner);border-top:2px solid var(--line);padding:clamp(12px,2vw,18px) clamp(18px,3vw,28px);
    padding-bottom:calc(clamp(12px,2vw,18px) + var(--footer-safe-area));display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;z-index:100;box-shadow:0 -6px 18px rgba(6,11,20,.24);margin-inline:calc(-1 * var(--page-pad))}
  .footer-meta{display:flex;flex-direction:column;gap:2px;color:var(--muted)}
  .footer-meta strong{color:var(--ink);font-size:clamp(14px,1.7vw,16px)}
  .footer-actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .footer-button{appearance:none;border:2px solid var(--line);background:var(--btn);color:var(--ink);padding:0 clamp(12px,2vw,16px);border-radius:10px;font-weight:700;cursor:pointer;height:var(--btn-height-md)}
  .footer-button:hover{background:var(--btn-hover)}
  .footer-button[disabled]{opacity:.6;cursor:not-allowed}
  .footer-theme{display:flex;align-items:center;gap:10px}
  .footer-theme-label{color:var(--muted);font-weight:600}

  .section-banner{display:flex;align-items:center;justify-content:space-between;gap:14px;background:var(--banner);border:2px solid var(--line);border-radius:12px;padding:var(--panel-pad)}
  .section-title{display:flex;gap:10px;align-items:center;color:var(--ink);font-weight:800;font-size:clamp(18px,2.4vw,22px);margin:0}
  .section-subtitle{margin:0;color:var(--muted);font-size:clamp(13px,1.6vw,15px)}

  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
  th{color:var(--ink)}
  tr:hover{background:var(--card-hover)}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{appearance:none;border:2px solid var(--line);background:var(--btn);color:var(--text);padding:0 clamp(12px,2vw,16px);border-radius:10px;font-weight:700;cursor:pointer;height:var(--btn-height-lg)}
  .btn:hover{background:var(--btn-hover)}
  .btn-sm{height:var(--btn-height-sm);padding:0 clamp(10px,1.6vw,14px);font-size:.92em}
  .detail{background:var(--detail);border:2px solid var(--line);border-radius:12px;padding:var(--panel-pad)}
  .ai-section{display:grid;gap:10px;margin-top:14px}
  .ai-field-grid{display:grid;gap:10px}
  .ai-field-grid .ai-field{display:grid;gap:4px;background:var(--card);border:1px solid var(--line);border-radius:10px;padding:10px}
  .ai-field-grid dt{margin:0;font-weight:700;color:var(--ink);font-size:clamp(13px,1.5vw,15px)}
  .ai-field-grid dd{margin:0;color:var(--text);font-size:clamp(13px,1.6vw,15px);word-break:break-word}
  .ai-field-grid ul{margin:6px 0 0 18px;padding:0;color:inherit}
  .ai-field-grid li{margin:2px 0}
  .ai-field-grid .ai-empty{color:var(--muted);font-style:italic}
  .override-form{display:grid;gap:10px;margin-top:4px}
  .override-form h5{margin:0;color:var(--ink);font-size:clamp(14px,1.7vw,16px)}
  .override-form label{display:grid;gap:6px;font-weight:600;color:var(--ink)}
  .override-form select,.override-form textarea{padding:10px 12px;border:2px solid var(--line);border-radius:10px;background:var(--card);color:var(--text);font:inherit;min-height:44px}
  .override-form textarea{min-height:90px;resize:vertical}
  .override-form .form-actions{display:flex;gap:10px;flex-wrap:wrap}
  .override-status{font-size:clamp(12px,1.4vw,14px)}
  .override-status[data-status="error"]{color:var(--red)}
  .override-status[data-status="success"]{color:var(--green)}
  .crumbs{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:clamp(13px,1.6vw,15px);margin-bottom:12px}
  .crumbs strong{color:var(--ink)}
  .crumbs button{background:none;border:none;color:var(--ink);font-weight:700;cursor:pointer;padding:0;font-size:inherit}
  .crumbs button:hover{text-decoration:underline}
</style>
</head>
<body>
  <main class="frame">
    <div id="globalShell"></div>
    <section class="page-sections" data-page-root>
      <section class="inner" data-test="first-section" data-panel>
      <header class="section-banner">
        <h1 class="section-title">Mail Integration (Outlook)</h1>
        <p class="section-subtitle">Manage synced data and review connection health.</p>
      </header>

      <div class="actions">
        <button class="btn btn-sm" id="reset" data-test-reset>Reset Test Data</button>
      </div>

      <div class="detail" id="listPanel">
        <h3 style="margin:0 0 8px 0;color:var(--ink)">Inbox (test data)</h3>
        <div style="overflow:auto">
          <table id="tbl">
            <thead><tr><th>From</th><th>Subject</th><th>Status</th><th>Received</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="detail" id="detailPanel" hidden>
        <div class="crumbs">
          <button type="button" id="backToList">Inbox</button>
          <span>/</span>
          <strong id="detailSubject">Details</strong>
        </div>
        <h3 id="detailHeading" style="margin:0 0 8px 0;color:var(--ink)">Select an email</h3>
        <p id="detailMeta">Choose a message from the inbox to review its contents.</p>
        <p id="detailBody"></p>
        <section id="detailAiSection" class="ai-section">
          <h4 style="margin:0;color:var(--ink);font-size:clamp(15px,1.8vw,17px)">AI readiness</h4>
          <dl class="ai-field-grid" id="detailAiFields"></dl>
          <form class="override-form" id="manualOverrideForm">
            <h5>Manual override</h5>
            <label for="overrideCategory">Category</label>
            <select id="overrideCategory" name="overrideCategory">
              <option value="grey">Grey — Metadata pending</option>
              <option value="green">Green — Ready for automation</option>
              <option value="blue">Blue — Needs context</option>
              <option value="red">Red — Manual review</option>
            </select>
            <label for="overrideNote">Note (optional)</label>
            <textarea id="overrideNote" name="overrideNote" placeholder="Add context for this override"></textarea>
            <div class="form-actions">
              <button class="btn" type="submit" id="overrideSubmit">Save override</button>
              <button class="btn" type="button" id="detailReassess">Reassess AI metadata</button>
            </div>
            <p class="meta override-status" id="overrideStatus" role="status" hidden></p>
          </form>
        </section>
      </div>
      </section>
    </section>
  </main>

  <footer id="appFooter" class="app-footer" role="contentinfo"></footer>

<script src="footer-overscroll.js"></script>
<script src="ai-classifier.js"></script>
<script src="manual-override-service.js"></script>
<script>
  const DB_KEY='faux-emails', AUTH_KEY='faux-auth';
  function svgPentagon(){ return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l9 6-3.4 10.5H6.4L3 8l9-6z"/></svg>'; }
  function escapeHtml(str=''){
    const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
    return String(str).replace(/[&<>"']/g, ch => map[ch]);
  }
  function isAuthed(){ return !!localStorage.getItem(AUTH_KEY); }
  function getCurrentUser(){ return localStorage.getItem(AUTH_KEY) || ''; }
  function globalMenuHtml({authed=false}={}){
    const currentPage = (window.location.pathname.split('/').pop() || 'admin.html').toLowerCase();
    const navLinks = authed
      ? [
          {href:'index.html', label:'Activity'},
          {href:'ai-review.html', label:'AI review'},
          {href:'admin.html', label:'Admin'}
        ].map(({href,label}) => {
          const isCurrent = currentPage === href.toLowerCase();
          const aria = isCurrent ? ' aria-current="page"' : '';
          return `<a class="link" href="${href}"${aria}>${label}</a>`;
        }).join('')
      : '';
    const navAttrs = navLinks
      ? 'aria-label="Primary navigation"'
      : 'aria-label="Primary navigation" aria-hidden="true"';
    const navBody = navLinks || '<span class="primary-menu__placeholder">Menu unavailable</span>';
    return `
      <div class="global-shell" data-shell>
        <header class="app-header" data-shell-header data-test="app-header">
          <div class="app-logo" data-shell-logo aria-hidden="true">${svgPentagon()}</div>
          <div class="app-title" data-shell-title role="heading" aria-level="1">Operations Console</div>
          <nav class="primary-menu" ${navAttrs} data-shell-menu data-test="app-menu">${navBody}</nav>
        </header>
      </div>`;
  }

  function globalFooterHtml({authed=false, user=''}={}){
    const displayName = authed && user ? escapeHtml(user) : '—';
    const themeLabel = document.documentElement.getAttribute('data-theme')==='light' ? 'Light' : 'Dark';
    const logoutAttrs = authed ? '' : ' disabled aria-disabled="true"';
    return `
      <div class="footer-meta" aria-live="polite">
        <span>Signed in as</span>
        <strong>${displayName}</strong>
      </div>
      <div class="footer-actions">
        <button class="footer-button" type="button" id="logoutBtn"${logoutAttrs}>Logout</button>
        <div class="footer-theme">
          <span class="footer-theme-label" id="themeLabel">${themeLabel}</span>
          <button class="toggle" type="button" id="themeToggle" aria-pressed="false">
            <span class="knob"></span>
          </button>
        </div>
      </div>`;
  }

  function getShellLayoutTokens(){
    const styles = getComputedStyle(document.documentElement);
    const read = (name) => parseFloat(styles.getPropertyValue(name)) || 0;
    return {
      header: read('--shell-header-height'),
      gap: read('--shell-page-top-gap')
    };
  }

  const oversizeButtonsLogged = new WeakSet();
  const BUTTON_SELECTORS = ['.btn', '.btn-sm', '.link', '.footer-button', '.pill', '.inline-alert button', '.empty-refresh'];

  function describeButton(el){
    if(!el) return 'unknown';
    const dataTest = el.getAttribute('data-test');
    if(dataTest) return `[data-test=${dataTest}]`;
    if(el.id) return `#${el.id}`;
    const name = el.getAttribute('name');
    if(name) return `${el.tagName.toLowerCase()}[name="${name}"]`;
    const className = typeof el.className === 'string'
      ? el.className.trim().split(/\s+/).filter(Boolean).join('.')
      : '';
    if(className) return `${el.tagName.toLowerCase()}.${className}`;
    const label = (el.textContent || '').trim();
    if(label) return `${el.tagName.toLowerCase()}(${label.slice(0,24)})`;
    return el.tagName.toLowerCase();
  }

  function scanButtonHeights(){
    if(typeof document === 'undefined') return;
    const nodes = [];
    BUTTON_SELECTORS.forEach(selector => {
      document.querySelectorAll(selector).forEach(el => nodes.push(el));
    });
    if(!nodes.length) return;
    const unique = Array.from(new Set(nodes));
    const mm = typeof matchMedia === 'function' ? matchMedia('(max-width:720px)') : null;
    const cap = mm && mm.matches ? 38 : 44;
    unique.forEach(el => {
      if(!(el instanceof Element)) return;
      const rect = el.getBoundingClientRect();
      if(rect.height > cap + 0.5 && !oversizeButtonsLogged.has(el)){
        oversizeButtonsLogged.add(el);
        console.warn(`[ui] oversize button id=${describeButton(el)} h=${rect.height.toFixed(1)}px`);
      }
    });
  }

  function logLayoutProbe(){
    const raf = typeof requestAnimationFrame === 'function' ? requestAnimationFrame : null;
    if(!raf) return;
    raf(() => {
      raf(() => {
        const header = document.querySelector('[data-shell-header]');
        const sections = document.querySelector('.page-sections');
        if(!header || !sections){
          scanButtonHeights();
          return;
        }
        const tokens = getShellLayoutTokens();
        const headerBottom = header.offsetTop + header.offsetHeight;
        const sectionsOffset = sections.offsetTop;
        const relativeOffset = sectionsOffset - headerBottom;
        const okTop = Math.abs(relativeOffset - tokens.gap) <= 1;
        console.log(`[layout] topInset=${tokens.gap.toFixed(1)}px sections.offsetTop=${sectionsOffset.toFixed(1)}px okTop=${okTop}`);
        scanButtonHeights();
      });
    });
  }

  function renderFooter({authed=false, user='', onLogout}={}){
    const host = document.getElementById('appFooter');
    if(!host) return;
    host.innerHTML = globalFooterHtml({authed, user});
    attachGlobalFooterHandlers(onLogout);
  }

  function handleLogout(){
    localStorage.removeItem(AUTH_KEY);
    window.location.replace('index.html');
  }

  function attachGlobalFooterHandlers(onLogout){
    syncThemeControls();
    const toggle = document.getElementById('themeToggle');
    if(toggle){
      toggle.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme') || 'dark';
        setTheme(current === 'dark' ? 'light' : 'dark');
      });
    }
    const logout = document.getElementById('logoutBtn');
    if(logout && !logout.disabled){
      logout.addEventListener('click', () => {
        if(typeof onLogout === 'function'){
          onLogout();
        } else {
          handleLogout();
        }
      });
    }
  }

  function seedDB(){
    if(localStorage.getItem(DB_KEY)) return;
    const now = Date.now();
    const emails = [
      {id:'e1', from:'billing@tenant.io', subject:'Payment overdue: INV-1043', body:'Please process the pending invoice within 3 days to avoid late fees. Manual review advised before charging the account.', status:'urgent', received: now-3600*1000*6},
      {id:'e2', from:'noreply@mailer.ai', subject:'Draft reply prepared', body:'AI drafted a response to tenant question about parking. Review and approve to send automatically.', status:'draft', received: now-3600*1000*12},
      {id:'e3', from:'support@locks.example', subject:'Smartlock offline – needs context', body:'Device reported intermittent connectivity and needs context about the environment before attempting a reset.', status:'needs_context', received: now-3600*1000*22},
      {id:'e4', from:'updates@crm.example', subject:'Profile note: tenant has a dog', body:'FYI: Add pet note to the profile. No action required yet.', status:'info', received: now-3600*1000*30},
      {id:'e5', from:'system@ops.example', subject:'Unhandled case detected', body:'AI could not determine a safe action. Manual review required to resolve the unhandled workflow.', status:'manual', received: now-3600*1000*40}
    ];
    const assessed = window.AIClassifier ? window.AIClassifier.ingest(emails, new Date(now)) : emails;
    localStorage.setItem(DB_KEY, JSON.stringify(assessed));
  }

  function rawEmails(){
    try {
      return JSON.parse(localStorage.getItem(DB_KEY)) || [];
    } catch {
      return [];
    }
  }

  function persistEmails(emails){
    localStorage.setItem(DB_KEY, JSON.stringify(emails));
  }

  function getEmails(){
    const emails = rawEmails();
    let mutated = false;
    if(window.AIClassifier){
      emails.forEach(email => {
        const version = email.ai && email.ai.assessor_version;
        if(!email.ai){
          window.AIClassifier.applyAssessment(email);
          mutated = true;
        } else if(version === 'manual-override'){
          email.aiCategory = email.ai.category;
          email.aiSynopsis = email.ai.notes;
        } else if(version !== window.AIClassifier.VERSION){
          window.AIClassifier.applyAssessment(email);
          mutated = true;
        } else {
          email.aiCategory = email.ai.category;
          email.aiSynopsis = email.ai.notes;
        }
      });
    }
    if(mutated){
      persistEmails(emails);
    }
    return emails;
  }

  function reassessEmail(id){
    if(!window.AIClassifier) return null;
    const emails = rawEmails();
    const updated = window.AIClassifier.reassess(emails, id, new Date());
    if(updated){
      persistEmails(emails);
    }
    return updated;
  }

  window.aiAssessorAPI = {
    reassessEmail
  };
  function fmt(ts){return new Date(ts).toLocaleString()}
  function setTheme(theme){
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('notif-theme', theme);
    syncThemeControls();
  }
  function syncThemeControls(){
    const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
    const label = document.getElementById('themeLabel');
    if(label){
      label.textContent = currentTheme === 'light' ? 'Light' : 'Dark';
    }
    const toggle = document.getElementById('themeToggle');
    if(toggle){
      const isLight = currentTheme === 'light';
      toggle.setAttribute('aria-pressed', isLight ? 'true' : 'false');
      toggle.setAttribute('aria-label', isLight ? 'Switch to dark theme' : 'Switch to light theme');
    }
  }
  (function initTheme(){
    const stored = localStorage.getItem('notif-theme');
    if(stored){ setTheme(stored); } else {
      const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      setTheme(prefersLight ? 'light' : 'dark');
    }
  })();
  const authed = isAuthed();
  const currentUser = authed ? getCurrentUser() : '';
  const globalShellHost = document.getElementById('globalShell');
  if(globalShellHost){
    globalShellHost.innerHTML = globalMenuHtml({authed});
  }
  renderFooter({authed, user:currentUser, onLogout:authed ? handleLogout : undefined});
  logLayoutProbe();
  if(!authed){
    window.location.replace('index.html');
  } else {
  seedDB();

  const tbody = document.querySelector('#tbl tbody');
  const listPanel = document.getElementById('listPanel');
  const detailPanel = document.getElementById('detailPanel');
  const detailSubject = document.getElementById('detailSubject');
  const detailHeading = document.getElementById('detailHeading');
  const detailMeta = document.getElementById('detailMeta');
  const detailBody = document.getElementById('detailBody');
  const detailAiFields = document.getElementById('detailAiFields');
  const manualOverrideForm = document.getElementById('manualOverrideForm');
  const overrideCategory = document.getElementById('overrideCategory');
  const overrideNote = document.getElementById('overrideNote');
  const overrideSubmit = document.getElementById('overrideSubmit');
  const overrideStatus = document.getElementById('overrideStatus');
  const detailReassess = document.getElementById('detailReassess');
  const backToList = document.getElementById('backToList');

  let activeEmailId = null;

  const AI_FIELD_ORDER = ['category', 'notes', 'assessor_version', 'assessed_at', 'confidence', 'blockers', 'required_permissions', 'required_context'];
  const ALLOWED_CATEGORIES = ['grey', 'green', 'blue', 'red'];

  function ensureAiObject(value){
    return value && typeof value === 'object' ? value : {};
  }

  function formatAiValue(value){
    if(Array.isArray(value)){
      if(!value.length){
        return '<span class="ai-empty">None</span>';
      }
      return `<ul>${value.map(item => `<li>${escapeHtml(String(item))}</li>`).join('')}</ul>`;
    }
    if(value === null || value === undefined || value === ''){
      return '<span class="ai-empty">None</span>';
    }
    if(typeof value === 'object'){
      return `<pre style="margin:0">${escapeHtml(JSON.stringify(value, null, 2))}</pre>`;
    }
    return `<span>${escapeHtml(String(value))}</span>`;
  }

  function renderAiFields(ai){
    if(!detailAiFields) return;
    const source = ensureAiObject(ai);
    const entries = [];
    const used = new Set();
    AI_FIELD_ORDER.forEach(key => {
      if(Object.prototype.hasOwnProperty.call(source, key)){
        entries.push([key, source[key]]);
        used.add(key);
      }
    });
    Object.keys(source).forEach(key => {
      if(!used.has(key)){
        entries.push([key, source[key]]);
      }
    });
    if(!entries.length){
      detailAiFields.innerHTML = '<div class="ai-field"><dt>ai</dt><dd><span class="ai-empty">No AI metadata available.</span></dd></div>';
      return;
    }
    detailAiFields.innerHTML = entries.map(([key, value]) => `
      <div class="ai-field">
        <dt>${escapeHtml(`ai.${key}`)}</dt>
        <dd>${formatAiValue(value)}</dd>
      </div>
    `).join('');
  }

  function clearOverrideStatus(){
    if(!overrideStatus) return;
    overrideStatus.hidden = true;
    overrideStatus.textContent = '';
    overrideStatus.removeAttribute('data-status');
  }

  function setOverrideStatus(message, status){
    if(!overrideStatus) return;
    overrideStatus.textContent = message;
    overrideStatus.hidden = false;
    if(status){
      overrideStatus.setAttribute('data-status', status);
    } else {
      overrideStatus.removeAttribute('data-status');
    }
  }

  function hydrateOverrideControls(ai){
    if(!manualOverrideForm) return;
    const category = (ai && ai.category ? String(ai.category).toLowerCase() : 'grey');
    const normalized = ALLOWED_CATEGORIES.includes(category) ? category : 'grey';
    if(overrideCategory){
      overrideCategory.value = normalized;
    }
    if(overrideNote){
      const note = ai && ai.assessor_version === 'manual-override' ? (ai.notes || '') : '';
      overrideNote.value = note === 'Manual override applied.' ? '' : note;
    }
    clearOverrideStatus();
    if(overrideSubmit){
      overrideSubmit.disabled = false;
    }
  }

  function populateAi(email){
    const ai = ensureAiObject(email.ai);
    renderAiFields(ai);
    hydrateOverrideControls(ai);
  }

  function showList(){
    listPanel.hidden = false;
    detailPanel.hidden = true;
  }
  function showDetail(email){
    detailSubject.textContent = email.subject;
    detailHeading.textContent = email.subject;
    detailMeta.innerHTML = `<strong>From:</strong> ${email.from} • <strong>Received:</strong> ${fmt(email.received)} • <strong>Status:</strong> ${email.status}`;
    detailBody.textContent = email.body;
    populateAi(email);
    activeEmailId = email.id;
    listPanel.hidden = true;
    detailPanel.hidden = false;
  }

  backToList.addEventListener('click', showList);

  function overrideFetchStub(url, options){
    return Promise.resolve({ ok: true, url, options });
  }

  async function submitManualOverride(event){
    event.preventDefault();
    if(!manualOverrideForm || !window.ManualOverrideService){
      setOverrideStatus('Manual override service unavailable.', 'error');
      return;
    }
    if(!activeEmailId){
      setOverrideStatus('Select a message before saving an override.', 'error');
      return;
    }
    if(overrideSubmit){
      overrideSubmit.disabled = true;
    }
    clearOverrideStatus();
    try {
      await window.ManualOverrideService.persistOverride({
        id: activeEmailId,
        category: overrideCategory ? overrideCategory.value : 'grey',
        note: overrideNote ? overrideNote.value : ''
      }, {
        storage: localStorage,
        now: new Date(),
        fetchImpl: overrideFetchStub
      });
      const emails = getEmails();
      const refreshed = emails.find(item => item.id === activeEmailId);
      if(refreshed){
        showDetail(refreshed);
      }
      setOverrideStatus('Manual override saved.', 'success');
      render();
    } catch (err){
      const message = err && err.message ? err.message : 'Unable to save manual override.';
      setOverrideStatus(`Failed to save override: ${message}`, 'error');
    } finally {
      if(overrideSubmit){
        overrideSubmit.disabled = false;
      }
    }
  }

  if(manualOverrideForm){
    manualOverrideForm.addEventListener('submit', submitManualOverride);
  }

  function render(){
    const emails = getEmails();
    tbody.innerHTML = emails.map(e => `
      <tr>
        <td>${e.from}</td>
        <td>${e.subject}</td>
        <td>${e.status}</td>
        <td>${fmt(e.received)}</td>
        <td><button class="btn" data-id="${e.id}">View</button></td>
      </tr>`).join('');
    tbody.querySelectorAll('button[data-id]').forEach(b => b.onclick = () => viewEmail(b.getAttribute('data-id')));
  }
  function viewEmail(id){
    const emails = getEmails();
    const e = emails.find(x=>x.id===id); if(!e) return;
    showDetail(e);
  }

  if(detailReassess){
    detailReassess.addEventListener('click', () => {
      if(!activeEmailId) return;
      const updated = reassessEmail(activeEmailId);
      if(updated){
        const emails = getEmails();
        const refreshed = emails.find(item => item.id === activeEmailId);
        if(refreshed){
          showDetail(refreshed);
        }
      }
    });
  }

  document.getElementById('reset').onclick = ()=>{ localStorage.removeItem(DB_KEY); seedDB(); render(); showList(); };
  render();
  showList();
  }
</script>
</body>
</html>
