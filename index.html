<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Activity Feed</title>
<link
  rel="stylesheet"
  href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap"
/> 
<style>
  :root {
    --radius:14px;
    --gap:var(--space-3);
    --focus:#6ea4e8;
    --page-pad:var(--space-4);
    --frame-gap:var(--space-3);
    --shell-header-height:77px;
    --shell-page-top-gap:calc(var(--space-4) + var(--space-1) / 2);
    --shell-header-height-mobile:69.5px;
    --shell-page-top-gap-mobile:var(--space-3);
    --shell-header-pad-inline:var(--space-4);
    --shell-logo-size:96px;
    --shell-logo-size-mobile:64px;
    --panel-pad:var(--space-4);
    --panel-pad-mobile:var(--space-3);
    --footer-safe-area:env(safe-area-inset-bottom);
    --card-stripe:calc(var(--space-1) + var(--space-1) / 2);
    --btn-height-sm:34px;
    --btn-height-md:38px;
    --btn-height-lg:42px;
    --btn-height-max:44px;
    --btn-height-sm-mobile:32px;
    --btn-height-md-mobile:34px;
    --btn-height-lg-mobile:36px;
    --btn-height-max-mobile:38px;

    /* Blomfelt brand palette */
    --blomfelt-green:#2C403A;
    --blomfelt-black:#000000;
    --blomfelt-white:#FFFFFF;
    --blomfelt-bright-blue:#AFD0E7;
    --blomfelt-yellow:#FDF6E1;
    --blomfelt-coral:#FFA899;
    --blomfelt-sunny:#F9C271;
    --blomfelt-lavender:#E5C8F8;
  }
  @media (max-width:720px){
    :root{
      --shell-header-height:var(--shell-header-height-mobile);
      --shell-page-top-gap:var(--shell-page-top-gap-mobile);
      --shell-logo-size:var(--shell-logo-size-mobile);
      --panel-pad:var(--panel-pad-mobile);
      --btn-height-sm:var(--btn-height-sm-mobile);
      --btn-height-md:var(--btn-height-md-mobile);
      --btn-height-lg:var(--btn-height-lg-mobile);
      --btn-height-max:var(--btn-height-max-mobile);
    }
  }
  :root, html[data-theme="dark"] {
    --bg:#141b26; --panel:#1a2330; --ink:#f4f7fb; --text:#d7dee7; --muted:#a5b3c5;
    --line:#364353; --card:#1d2735; --card-hover:#243041; --banner:#1b2534;
    --detail:#202b3b; --btn:#232f3f; --btn-hover:#2a3749; --accent-muted:#93a5bb;
    --red:#ea7c76; --green:#5ec49d; --blue:#78aeea; --amber:#e7ad6a; --crimson:#ed8a7d; --grey:#8a97ab;
    --shadow:0 6px 24px rgba(6,11,20,.32);
  }
  html[data-theme="light"] {
    --bg:#f2f4f7; --panel:#ffffff; --ink:#1e2936; --text:#2e3a4c; --muted:#647184;
    --line:#d0d7e2; --card:#ffffff; --card-hover:#f5f7fa; --banner:#f1f3f7;
    --detail:#f7f9fc; --btn:#eceff5; --btn-hover:#e1e5ed; --accent-muted:#7b889b;
    --red:#c6615b; --green:#3c8f6b; --blue:#3a7bd5; --amber:#c38b44; --crimson:#c46f63; --grey:#6b778a;
    --shadow:0 4px 18px rgba(15,23,42,.08); --focus:#3a7bd5;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);
    min-height:100vh;display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;
    gap:var(--page-pad);padding:var(--page-pad);
    overflow-x:hidden;transition:background .2s,color .2s}
  .frame{margin:0 auto;width:min(1100px,100%);max-width:100%;background:var(--panel);border:2px solid var(--line);
    border-radius:18px;padding:var(--space-4);box-shadow:var(--shadow);
    display:grid;gap:0;flex:1 0 auto;min-height:0;align-content:start;align-items:start}
  .frame > *{margin-block:0}
  .frame > :first-child{margin-block-start:0}
  .frame > :first-child + *{margin-block-start:0}
  .global-shell{display:contents}
  .app-header{background:var(--banner);border:2px solid var(--line);border-radius:12px;
    padding:var(--space-3) 0;display:flex;justify-content:center;width:100%;box-sizing:border-box;
    height:var(--shell-header-height);min-height:0;position:relative}
  .app-header > .inner{display:flex;align-items:center;gap:var(--space-3);width:100%}
  .app-logo{width:var(--shell-logo-size);height:var(--shell-logo-size);flex:0 0 auto;
    display:flex;align-items:center;justify-content:center;color:var(--ink);text-decoration:none}
  .app-logo img{display:block;max-height:100%;width:auto}
  .app-title{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);text-align:center;
    color:var(--ink);white-space:nowrap;pointer-events:none}
  .primary-menu{gap:calc(var(--space-2) + var(--space-1) / 2);justify-content:flex-end;overflow-x:auto;flex-wrap:nowrap;margin:0;margin-left:auto;
    scrollbar-width:none;display:flex;align-items:center;flex:0 1 auto;padding:0}
  .primary-menu[aria-hidden="true"]{justify-content:flex-end}
  .primary-menu::-webkit-scrollbar{display:none}
  .primary-menu__placeholder{opacity:.4}
  .page-sections{
    display:grid;
    gap:var(--frame-gap);
    margin:0;
    padding:var(--shell-page-top-gap) 0 0;
    position:relative;
    min-height:0;
    width:100%;
    box-sizing:border-box;
  }
  .page-sections > *{margin-block:0;scroll-margin-top:var(--shell-header-height)}
  .page-sections > :first-child{margin-block-start:0}

  /* Global navigation */
  .btn,
  .btn-sm,
  .link,
  .footer-button,
  .pill,
  .inline-alert button,
  .empty-refresh{box-sizing:border-box;display:inline-flex;align-items:center;justify-content:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;max-width:100%;min-height:0;max-height:var(--btn-height-max);gap:calc(var(--space-1) + var(--space-1) / 2)}
  .link{color:var(--ink);text-decoration:none;padding:0 var(--space-4);border-radius:10px;border:2px solid var(--line);background:var(--btn);cursor:pointer;flex:0 0 auto;height:var(--btn-height-md)}
  .link:hover{background:var(--btn-hover)}
  .link[aria-current="page"]{background:var(--ink);color:var(--bg);border-color:var(--ink)}
  .toggle{width:54px;height:30px;border-radius:100px;border:2px solid var(--line);background:var(--btn);position:relative;cursor:pointer}
  .toggle:hover{background:var(--btn-hover)}
  .toggle:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
  .knob{width:22px;height:22px;border-radius:50%;background:var(--ink);position:absolute;top:50%;transform:translateY(-50%);left:4px;transition:left .2s}
  html[data-theme="light"] .knob{left:28px}
  .app-footer{position:sticky;bottom:0;background:var(--banner);border-top:2px solid var(--line);
    padding:var(--space-4) calc(var(--space-4) + var(--space-3));
    padding-bottom:calc(var(--space-4) + var(--footer-safe-area));display:flex;flex-wrap:wrap;gap:var(--space-3);align-items:center;
    justify-content:space-between;z-index:100;box-shadow:0 -6px 18px rgba(6,11,20,.24);margin-inline:calc(-1 * var(--page-pad))}
  .footer-meta{display:flex;flex-direction:column;gap:calc(var(--space-1) / 2);color:var(--muted)}
  .footer-meta strong{color:var(--ink)}
  .footer-actions{display:flex;gap:var(--space-3);align-items:center;flex-wrap:wrap}
  .footer-button{appearance:none;border:2px solid var(--line);background:var(--btn);color:var(--ink);
    padding:0 var(--space-4);border-radius:10px;cursor:pointer;height:var(--btn-height-md)}
  .footer-button:hover{background:var(--btn-hover)}
  .footer-button[disabled]{opacity:.6;cursor:not-allowed}
  .footer-theme{display:flex;align-items:center;gap:calc(var(--space-2) + var(--space-1) / 2)}
  .footer-theme-label{color:var(--muted)}

  /* Section banner */
  .section-banner{display:flex;align-items:center;justify-content:space-between;gap:calc(var(--space-3) + var(--space-1) / 2);
    padding:var(--panel-pad);background:var(--banner);border:2px solid var(--line);border-radius:12px}
  .section-title{display:flex;align-items:center;gap:calc(var(--space-2) + var(--space-1) / 2);color:var(--ink);margin:0 0 var(--space-3) 0}
  .section-subtitle{margin:0;color:var(--muted)}

  /* Cards list */
  .stack{display:grid;gap:var(--space-4)}
  .group{display:grid;gap:var(--space-3)}
  .group-title{color:var(--ink)}
  .group-cards{display:grid;gap:var(--space-3)}
  .card{display:grid;grid-template-columns:var(--card-stripe) 1fr auto;gap:0;align-items:stretch;
    padding:0;background:var(--card);border-radius:var(--radius);border:2px solid var(--line);
    cursor:pointer;transition:background .15s,transform .05s,border-color .2s;text-align:left;min-height:132px;overflow:hidden}
  .card:hover{background:var(--card-hover);transform:translateY(-1px)}
  .card:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
  .card-stripe{width:var(--card-stripe);min-width:var(--card-stripe);background:var(--grey);align-self:stretch}
  .card-stripe-green{background:var(--green)}
  .card-stripe-red{background:var(--red)}
  .card-stripe-blue{background:var(--blue)}
  .card-stripe-grey{background:var(--grey)}
  .card-content{display:grid;gap:calc(var(--space-1) + var(--space-1) / 2);padding:var(--space-4);padding-right:calc(var(--space-3) + var(--space-1) / 2)}
  .card-header{display:flex;align-items:center;justify-content:space-between;gap:var(--space-3)}
  .title-text{color:var(--ink);margin:0}
  .description{color:var(--text);opacity:.9;margin:0}
  .meta{color:var(--muted)}
  .chev{opacity:.9;align-self:center;padding:0 var(--space-4);display:flex;align-items:center;justify-content:center}
  .badge{display:inline-flex;align-items:center;gap:calc(var(--space-1) + var(--space-1) / 2);padding:var(--space-1) calc(var(--space-2) + var(--space-1) / 2);border-radius:999px;background:rgba(255,255,255,.08);color:var(--ink);border:1px solid var(--line)}
  .badge-urgent{background:rgba(255,94,94,.18);color:var(--ink);border-color:rgba(255,94,94,.45)}
  .timestamp{margin-left:auto;color:var(--muted)}
  .card.is-urgent{box-shadow:0 0 0 2px rgba(255,122,102,.55);border-color:rgba(255,122,102,.6)}

  /* Details: only one mode visible at a time */
  .detail{background:var(--detail);border:2px solid var(--line);border-radius:12px;padding:var(--panel-pad);min-height:160px}
  .detail .label{color:var(--muted);margin-bottom:6px}
  .detail h2{margin:0 0 var(--space-2) 0;color:var(--ink)}
  .detail p{margin:0 0 var(--space-3) 0}
  .detail .actions{display:flex;gap:calc(var(--space-2) + var(--space-1) / 2);flex-wrap:wrap}
  .btn{appearance:none;border:2px solid var(--line);background:var(--btn);color:var(--text);
    padding:0 var(--space-4);border-radius:10px;cursor:pointer;height:var(--btn-height-lg)}
  .btn-sm{height:var(--btn-height-sm);padding:0 calc(var(--space-3) + var(--space-1) / 2)}
  .btn:hover{background:var(--btn-hover)}

  .detail-view{display:none;grid-column:1/-1;gap:var(--space-4)}
  .detail-view[aria-hidden="false"]{display:grid}
  .detail-head{display:flex;flex-wrap:wrap;gap:calc(var(--space-2) + var(--space-1) / 2);align-items:center;justify-content:space-between}
  .crumbs{display:flex;align-items:center;gap:var(--space-2);color:var(--muted)}
  .crumbs strong{color:var(--ink)}
  .crumbs button{background:none;border:none;color:var(--ink);cursor:pointer;padding:0}
  .crumbs button:hover{text-decoration:underline}

  .feed-content[hidden]{display:none !important}

  /* Desktop aside visible, mobile inline visible */
  .aside{display:none}
  @media (min-width:900px){ .aside{display:none} .inline-detail{display:none !important} }
  @media (max-width:899px){ .aside{display:none} .inline-detail{display:block} }

  /* Login */
  .login-wrap{display:grid;gap:var(--space-4);max-width:420px;margin:auto}
  .card-plain{background:var(--panel);border:2px solid var(--line);border-radius:12px;padding:var(--space-4)}
  .input{width:100%;padding:var(--space-3) var(--space-3);border:2px solid var(--line);border-radius:10px;background:var(--card);color:var(--text)}
  .row{display:grid;gap:var(--space-3)}
  .error{color:#ff7a66}
  @media (min-width:560px){ .row{grid-template-columns:1fr 1fr} }
</style>
<link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="frame" id="app"></main>
  <footer id="footer" class="app-footer" role="contentinfo"></footer>

<script src="footer-overscroll.js"></script>
<script src="refresh-utils.js"></script>
<script src="ai-classifier.js"></script>
<script src="ai-category-constants.js"></script>
<script>
  const DB_KEY = 'faux-emails';
  const AUTH_KEY = 'faux-auth';
  const REFRESH_INTERVAL = window.AutoRefresh ? window.AutoRefresh.DEFAULT_INTERVAL : 15000;
  const AICategory = window.AICategory || {
    AI_CATEGORY_COPY: {},
    normalizeCategory: () => 'grey',
    getCategoryPresentation: () => ({ key: 'grey', title: 'Unassessed', description: 'Awaiting AI review.', stripeClass: 'card-stripe-grey', ariaLabel: 'Unassessed' })
  };

  function seedDB(){
    if(localStorage.getItem(DB_KEY)) return;
    const now = Date.now();
    const emails = [
      {id:'e1', from:'billing@tenant.io', subject:'Payment overdue: INV-1043', body:'Please process the pending invoice within 3 days to avoid late fees. Manual review advised before charging the account.', status:'urgent', received: now-3600*1000*6},
      {id:'e2', from:'noreply@mailer.ai', subject:'Draft reply prepared', body:'AI drafted a response to tenant question about parking. Review and approve to send automatically.', status:'draft', received: now-3600*1000*12},
      {id:'e3', from:'support@locks.example', subject:'Smartlock offline – needs context', body:'Device reported intermittent connectivity and needs context about the environment before attempting a reset.', status:'needs_context', received: now-3600*1000*22},
      {id:'e4', from:'updates@crm.example', subject:'Profile note: tenant has a dog', body:'FYI: Add pet note to the profile. No action required yet.', status:'info', received: now-3600*1000*30},
      {id:'e5', from:'system@ops.example', subject:'Unhandled case detected', body:'AI could not determine a safe action. Manual review required to resolve the unhandled workflow.', status:'manual', received: now-3600*1000*40}
    ];
    const assessed = window.AIClassifier ? window.AIClassifier.ingest(emails, new Date(now)) : emails;
    localStorage.setItem(DB_KEY, JSON.stringify(assessed));
  }

  function rawEmails(){
    try {
      return JSON.parse(localStorage.getItem(DB_KEY)) || [];
    } catch {
      return [];
    }
  }

  function persistEmails(emails){
    localStorage.setItem(DB_KEY, JSON.stringify(emails));
  }

  function getEmails(){
    const emails = rawEmails();
    let mutated = false;
    if(window.AIClassifier){
      emails.forEach(email => {
        const originalVersion = email.ai && email.ai.assessor_version;
        if(!email.ai){
          window.AIClassifier.applyAssessment(email);
          mutated = true;
        } else if(originalVersion === 'manual-override'){
          email.aiCategory = email.ai.category;
          email.aiSynopsis = email.ai.notes;
        } else if(originalVersion !== window.AIClassifier.VERSION){
          window.AIClassifier.applyAssessment(email);
          mutated = true;
        } else {
          email.aiCategory = email.ai.category;
          email.aiSynopsis = email.ai.notes;
        }
      });
    }
    if(mutated){
      persistEmails(emails);
    }
    return emails;
  }

  function reassessEmail(id){
    const emails = rawEmails();
    if(!window.AIClassifier) return null;
    const updated = window.AIClassifier.reassess(emails, id, new Date());
    if(updated){
      persistEmails(emails);
    }
    return updated;
  }

  window.aiAssessorAPI = {
    reassessEmail
  };
  function isAuthed(){ return !!localStorage.getItem(AUTH_KEY) }
  function setTheme(theme){
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('notif-theme', theme);
    syncThemeControls();
  }
  function syncThemeControls(){
    const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
    const label = document.getElementById('themeLabel');
    if(label){
      label.textContent = currentTheme === 'light' ? 'Light' : 'Dark';
    }
    const toggle = document.getElementById('themeToggle');
    if(toggle){
      const isLight = currentTheme === 'light';
      toggle.setAttribute('aria-pressed', isLight ? 'true' : 'false');
      toggle.setAttribute('aria-label', isLight ? 'Switch to dark theme' : 'Switch to light theme');
    }
  }
  (function initTheme(){
    const stored = localStorage.getItem('notif-theme');
    if(stored){ setTheme(stored); return; }
    const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
    setTheme(prefersLight ? 'light' : 'dark');
  })();
  seedDB();

  let feedAutoRefresh = null;

  function disposeAutoRefresh(){
    if(feedAutoRefresh){
      feedAutoRefresh.dispose();
      feedAutoRefresh = null;
    }
  }

  function cardChevron(){ return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 6l6 6-6 6"/></svg>'; }

  function escapeHtml(str=''){
    const escapeMap = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    };
    return String(str).replace(/[&<>"']/g, ch => escapeMap[ch]);
  }

  function globalMenuHtml({authed=false}={}){
    const currentPage = (window.location.pathname.split('/').pop() || 'index.html').toLowerCase();
    const navLinks = authed
      ? [
          {href:'index.html', label:'Activity'},
          {href:'ai-review.html', label:'AI review'},
          {href:'admin.html', label:'Admin'}
        ].map(({href,label}) => {
          const isCurrent = currentPage === href.toLowerCase();
          const aria = isCurrent ? ' aria-current="page"' : '';
          return `<a class="link" href="${href}"${aria}>${label}</a>`;
        }).join('')
      : '';
    const navAttrs = navLinks
      ? 'aria-label="Primary navigation"'
      : 'aria-label="Primary navigation" aria-hidden="true"';
    const navBody = navLinks || '<span class="primary-menu__placeholder">Menu unavailable</span>';
    return `
      <div class="global-shell" data-shell>
        <header class="app-header" data-shell-header data-test="app-header">
          <div class="inner">
            <a class="app-logo" data-shell-logo href="index.html" aria-label="Blomfelt">
              <img src="design-manual/Asset 1_green.svg" alt="Blomfelt logo" />
            </a>
            <div class="app-title" data-shell-title role="heading" aria-level="1">Operations Console</div>
            <nav class="primary-menu" ${navAttrs} data-shell-menu data-test="app-menu">${navBody}</nav>
          </div>
        </header>
      </div>`;
  }

  function globalFooterHtml({authed=false, user=''}={}){
    const displayName = authed && user ? escapeHtml(user) : '—';
    const themeLabel = document.documentElement.getAttribute('data-theme')==='light' ? 'Light' : 'Dark';
    const logoutAttrs = authed ? '' : ' disabled aria-disabled="true"';
    return `
      <div class="footer-meta" aria-live="polite">
        <span>Signed in as</span>
        <strong>${displayName}</strong>
      </div>
      <div class="footer-actions">
        <button class="footer-button" type="button" id="logoutBtn"${logoutAttrs}>Logout</button>
        <div class="footer-theme">
          <span class="footer-theme-label" id="themeLabel">${themeLabel}</span>
          <button class="toggle" type="button" id="themeToggle" aria-pressed="false">
            <span class="knob"></span>
          </button>
        </div>
      </div>`;
  }

  function findMenuUnavailableElements(){
    const selectors = ['#menu', '.menu-unavailable', '.primary-menu__placeholder'];
    const nodes = new Set();
    selectors.forEach(selector => {
      document.querySelectorAll(selector).forEach(node => nodes.add(node));
    });
    return Array.from(nodes);
  }

  function applyAuthVisibility(){
    const body = document.body;
    if(!body) return;
    const isAuthedState = body.dataset.auth === 'true';
    const menuNodes = findMenuUnavailableElements();
    const footer = document.getElementById('footer');
    if(isAuthedState){
      menuNodes.forEach(node => node && node.style.removeProperty('display'));
      if(footer){
        footer.style.removeProperty('display');
      }
    } else {
      menuNodes.forEach(node => {
        if(node){
          node.style.display = 'none';
        }
      });
      if(footer){
        footer.style.display = 'none';
      }
    }
  }

  function syncAuthVisibility(authed){
    if(document.body){
      document.body.dataset.auth = authed ? 'true' : 'false';
    }
    applyAuthVisibility();
  }

  function getShellLayoutTokens(){
    const styles = getComputedStyle(document.documentElement);
    const read = (name) => parseFloat(styles.getPropertyValue(name)) || 0;
    return {
      header: read('--shell-header-height'),
      gap: read('--shell-page-top-gap')
    };
  }

  const oversizeButtonsLogged = new WeakSet();
  const BUTTON_SELECTORS = ['.btn', '.btn-sm', '.link', '.footer-button', '.pill', '.inline-alert button', '.empty-refresh'];

  function describeButton(el){
    if(!el) return 'unknown';
    const dataTest = el.getAttribute('data-test');
    if(dataTest) return `[data-test=${dataTest}]`;
    if(el.id) return `#${el.id}`;
    const name = el.getAttribute('name');
    if(name) return `${el.tagName.toLowerCase()}[name="${name}"]`;
    const className = typeof el.className === 'string'
      ? el.className.trim().split(/\s+/).filter(Boolean).join('.')
      : '';
    if(className) return `${el.tagName.toLowerCase()}.${className}`;
    const label = (el.textContent || '').trim();
    if(label) return `${el.tagName.toLowerCase()}(${label.slice(0,24)})`;
    return el.tagName.toLowerCase();
  }

  function scanButtonHeights(){
    if(typeof document === 'undefined') return;
    const nodes = [];
    BUTTON_SELECTORS.forEach(selector => {
      document.querySelectorAll(selector).forEach(el => nodes.push(el));
    });
    if(!nodes.length) return;
    const unique = Array.from(new Set(nodes));
    const mm = typeof matchMedia === 'function' ? matchMedia('(max-width:720px)') : null;
    const cap = mm && mm.matches ? 38 : 44;
    unique.forEach(el => {
      if(!(el instanceof Element)) return;
      const rect = el.getBoundingClientRect();
      if(rect.height > cap + 0.5 && !oversizeButtonsLogged.has(el)){
        oversizeButtonsLogged.add(el);
        console.warn(`[ui] oversize button id=${describeButton(el)} h=${rect.height.toFixed(1)}px`);
      }
    });
  }

  function logLayoutProbe(){
    const raf = typeof requestAnimationFrame === 'function' ? requestAnimationFrame : null;
    if(!raf) return;
    raf(() => {
      raf(() => {
        const header = document.querySelector('[data-shell-header]');
        const sections = document.querySelector('.page-sections');
        if(!header || !sections){
          scanButtonHeights();
          return;
        }
        const tokens = getShellLayoutTokens();
        const headerBottom = header.offsetTop + header.offsetHeight;
        const sectionStyles = getComputedStyle(sections);
        const paddingTop = parseFloat(sectionStyles.paddingTop) || 0;
        const contentOffset = sections.offsetTop + paddingTop;
        const relativeOffset = contentOffset - headerBottom;
        const okTop = Math.abs(relativeOffset - tokens.gap) <= 1;
        console.log(`[layout] topInset=${tokens.gap.toFixed(1)}px content.offsetTop=${contentOffset.toFixed(1)}px okTop=${okTop}`);
        scanButtonHeights();
      });
    });
  }

  function renderFooter({authed=false, user='', onLogout}={}){
    const host = document.getElementById('footer');
    if(!host) return;
    host.innerHTML = globalFooterHtml({authed, user});
    attachGlobalFooterHandlers(onLogout);
  }

  function handleLogout(){
    localStorage.removeItem(AUTH_KEY);
    renderLogin();
  }

  function attachGlobalFooterHandlers(onLogout){
    syncThemeControls();
    const toggle = document.getElementById('themeToggle');
    if(toggle){
      toggle.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme') || 'dark';
        setTheme(current === 'dark' ? 'light' : 'dark');
      });
    }
    const logout = document.getElementById('logoutBtn');
    if(logout && !logout.disabled){
      logout.addEventListener('click', () => {
        if(typeof onLogout === 'function'){
          onLogout();
        } else {
          handleLogout();
        }
        localStorage.removeItem(AUTH_KEY);
        renderLogin();
      });
    }
  }

  function renderFrame({authed=false, user='', content='', onLogout}={}){
    const el = document.getElementById('app');
    if(!el) return;
    el.innerHTML = `
      ${globalMenuHtml({authed})}
      <div class="container">
        <div class="inner">
          <section class="page-sections" data-page-root>${content}</section>
        </div>
      </div>`;
    const pageRoot = el.querySelector('[data-page-root]');
    if(pageRoot && pageRoot.firstElementChild){
      const first = pageRoot.firstElementChild;
      first.setAttribute('data-test', 'first-section');
    }
    renderFooter({authed, user, onLogout});
    syncAuthVisibility(authed);
    logLayoutProbe();
  }

  function renderLogin(){
    disposeAutoRefresh();
    renderFrame({
      authed:false,
      content:`
        <div class="login-wrap card-plain" data-test="first-section">
          <h2 style="margin:0 0 calc(var(--space-1) + var(--space-1) / 2) 0;color:var(--ink)">Sign in</h2>
          <p class="meta" style="margin:0 0 var(--space-3) 0">Enter your credentials to continue.</p>
          <div class="row">
            <input id="user" class="input" placeholder="Username" autocomplete="username">
            <input id="pass" class="input" placeholder="Password" type="password" autocomplete="current-password">
          </div>
          <div id="err" class="error" style="display:none">Invalid credentials</div>
          <div style="display:flex;justify-content:flex-end;align-items:center;gap:calc(var(--space-2) + var(--space-1) / 2);margin-top:var(--space-3)">
            <button class="btn" id="loginBtn">Login</button>
          </div>
        </div>`
    });
    document.getElementById('loginBtn').onclick = () => {
      const u = document.getElementById('user').value.trim();
      const p = document.getElementById('pass').value;
      // Faux auth: any username with password 'admin'
      if(p === 'admin' && u){
        localStorage.setItem(AUTH_KEY, u);
        renderFeed();
      } else {
        const e = document.getElementById('err'); e.style.display = 'block';
      }
    };
  }

  function getCurrentUser(){
    return localStorage.getItem(AUTH_KEY) || '';
  }


  function renderFeed(){
    if(!isAuthed()){ renderLogin(); return; }
    disposeAutoRefresh();
    const statusInfo = {
      'urgent': {badge:'Urgent', badgeClass:'badge-urgent'},
      'manual': {badge:'Manual review', badgeClass:''},
      'needs_context': {badge:'Needs context', badgeClass:''},
      'draft': {badge:'Draft ready', badgeClass:''},
      'info': {badge:'FYI', badgeClass:''}
    };
    const groups = [
      {title:'Urgent', statuses:['urgent']},
      {title:'Needs your attention', statuses:['manual','needs_context']},
      {title:'Follow ups', statuses:['draft']},
      {title:'Recent updates', statuses:['info']}
    ];
    const truncate = (text)=> text.length>160 ? text.slice(0,157)+'…' : text;
    const formatTime = (ts)=> new Date(ts).toLocaleString();

    const currentUser = getCurrentUser();
    renderFrame({
      authed:true,
      user:currentUser,
      content:`
        <header class="section-banner" data-test="first-section">
          <h1 class="section-title">Activity Feed</h1>
          <p class="section-subtitle">Monitor inbox triage and recent automation updates.</p>
        </header>
        <div class="feed-content" id="feedContent">
          <div class="stack" id="cardList"></div>
        </div>
        <div class="detail-view" id="detailView" aria-hidden="true">
          <div class="detail-head">
            <div class="crumbs">
              <button type="button" id="detailBack">Activity feed</button>
              <span>/</span>
              <strong id="detailCrumb">Details</strong>
            </div>
            <button class="btn" type="button" id="detailBackBtn">Back to feed</button>
          </div>
          <article class="detail" aria-live="polite">
            <div class="label">Email</div>
            <h2 id="detailTitle">Select a notification</h2>
            <p id="detailMeta">Pick an item from the feed to view more information.</p>
            <p id="detailBody"></p>
            <div class="actions">
              <button class="btn" id="detailOpen">Open</button>
              <button class="btn" id="detailAssign">Assign</button>
              <button class="btn" id="detailArchive">Archive</button>
            </div>
          </article>
        </div>`
    });

    const feedContent = document.getElementById('feedContent');
    const detailView = document.getElementById('detailView');
    const detailTitle = document.getElementById('detailTitle');
    const detailMeta = document.getElementById('detailMeta');
    const detailBody = document.getElementById('detailBody');
    const detailCrumb = document.getElementById('detailCrumb');
    const cardList = document.getElementById('cardList');

    const state = { emails:[], detailId:null };

    function buildGroups(emails){
      return groups.map(group => {
        const items = emails.filter(e => group.statuses.includes(e.status)).sort((a,b)=>b.received-a.received);
        if(!items.length) return '';
        const cards = items.map(e => {
          const info = statusInfo[e.status] || statusInfo.info;
          const categoryKey = AICategory.normalizeCategory(e.ai && e.ai.category || e.aiCategory);
          const stripe = AICategory.getCategoryPresentation(categoryKey);
          const urgentClass = e.status==='urgent' ? ' is-urgent' : '';
          return `<button class="card${urgentClass}" data-email="${e.id}">
            <span class="card-stripe ${stripe.stripeClass}" aria-label="${escapeHtml(stripe.title)}"></span>
            <div class="card-content">
              <div class="card-header">
                <span class="badge ${info.badgeClass}">${info.badge}</span>
                <span class="timestamp">${formatTime(e.received)}</span>
              </div>
              <div class="title-text">${e.subject}</div>
              <p class="description">${truncate(e.body)}</p>
            </div>
            <span class="chev">${cardChevron()}</span>
          </button>`;
        }).join('');
        return `<div class="group">
          <div class="group-title">${group.title}</div>
          <div class="group-cards">${cards}</div>
        </div>`;
      }).join('');
    }

    const showDetail = (email,{scrollIntoView=true}={}) => {
      const ai = email.ai || {};
      const confidence = typeof ai.confidence === 'number' ? Math.round(ai.confidence * 100) : null;
      const categoryKey = AICategory.normalizeCategory(ai.category);
      const presentation = AICategory.getCategoryPresentation(categoryKey);
      const aiSummary = `${presentation.title}${confidence !== null ? ` • ${confidence}% confidence` : ''}`;
      detailTitle.textContent = email.subject;
      detailMeta.innerHTML = `<strong>From:</strong> ${email.from} • <strong>Received:</strong> ${formatTime(email.received)} • <strong>AI:</strong> ${aiSummary}`;
      detailBody.textContent = email.body;
      detailCrumb.textContent = email.subject;
      feedContent.hidden = true;
      detailView.setAttribute('aria-hidden', 'false');
      state.detailId = email.id;
      if(scrollIntoView){
        detailView.scrollIntoView({behavior:'smooth', block:'start'});
      }
    };

    const hideDetail = () => {
      feedContent.hidden = false;
      detailView.setAttribute('aria-hidden', 'true');
      state.detailId = null;
    };

    document.getElementById('detailBack').addEventListener('click', hideDetail);
    document.getElementById('detailBackBtn').addEventListener('click', hideDetail);

    function attachCardHandlers(){
      cardList.querySelectorAll('.card[data-email]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-email');
          const email = state.emails.find(e => e.id === id);
          if(email){
            showDetail(email);
          }
        });
      });
    }

    function updateFeed({skipScroll=false}={}){
      const emails = getEmails();
      state.emails = emails.slice();
      const markup = buildGroups(emails);
      cardList.innerHTML = markup || '<p class="meta">No notifications available.</p>';
      attachCardHandlers();
      if(state.detailId){
        const current = state.emails.find(e => e.id === state.detailId);
        if(current){
          showDetail(current,{scrollIntoView:!skipScroll});
        } else {
          hideDetail();
        }
      }
    }

    updateFeed();

    if(window.AutoRefresh){
      feedAutoRefresh = window.AutoRefresh.createAutoRefresh({
        refresh: () => updateFeed({skipScroll:true}),
        intervalMs: REFRESH_INTERVAL,
        immediate: false,
        autoStart: false
      });
      feedAutoRefresh.start();
    }
  }
  // Boot
  if(isAuthed()){ renderFeed(); } else { renderLogin(); }
</script>
</body>
</html>
